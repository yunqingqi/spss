# 计算机网络自顶向下方法

先评价一下，感觉这本书和以往的书不太一样的地方就是他并不是五层结构从下开始讲，而是，从可能最容易理解的应用层，开始讲，这样我们会先接触自己最熟悉，并且这样也符合那个分布封装的过程，自上而下加首部之类的

由于当前的技术原因，所以可能做的不是很好，可以在后续复习的时候对插图进行修改

## 第1章 计算机网络和因特网

### 1.1什么是因特网

1.能够描述因特网的具体构成 即因特网的基本硬件和基本软件

2.根据为分布式应用提供服务的联网基础来描述

#### 1.1.1具体结构构成

把与因特网相连接的计算机和其他设备称为主机（host)或者端系统（end system） 记得这两个词可以通用

端系统通过通信链路和分组交换机连接到一起

链路的**传输速率**使用bit/s或者说是bps来描度量 

当一台端系统要向另一台端系统发送数据时，发送端系统将数据分段，并为每段加上首部字节。由此形成的信息包用计算机网络的术语来说称为分组（packet）。
应用层报文 运输层报文段 网络层数据包 数据链路层帧 物理层比特

分组交换姐有路由器（route）和链路层交换机（link-layer switch）两种前者位于网络核心，后者用于接入网中

#### 1.1.2 服务描述

从为应用程序提供服务的基础设施的角度来描述因特网

分布式应用程序（distributed application） 运行在端系统上

与因特网相连的端系统提供了一个套接字（socket interface），该接口规定了运行在一个端系统上的程序请求因因特网基础设施向运行在另一个端系统上的特定目的地程序交付数据的方式

#### 1.1.3 什么是协议

协议（protocol）定义了在两个或者多个通信实体之间交换报文的格式和顺序，以及报文发送和/或接受一条报文或者其他事件所采取的动作

### 1.2网络边缘
#### 1.2.1接入网
接入网是指讲端系统物理连接到其边缘路由器的网络。边缘路由器是端系统到任何其他远程端系统的路径上的第一台路由器。
##### 1.家庭接入
当今最流行的带宽住宅接入：数据用户线（digital subscriber line）和电缆（cable）
当使用DSL时，用户的本地电话公司就是他的ISP
每个用户的DSL调制解调器使用现有的电话线与位于电话公司的本地中心局的数字用户线接入复用器（DSLAM）交换数据。家庭的DSL调制解调器得到数字数据后将其转换为高频音，以通过电话线传输到本地中心句；来自许多家庭的模拟信号在DSLAM处被转化为数字形式。
这里是频分复用，原来的电话信号为低频，数据i信号为高频
非对称信道

电缆因特网接入（cable internet access）利用了有线电视公司的有线电视基础设施，他由于同时使用了光纤和同轴电缆，因此也被称为混合光纤同轴HFC（Hybrid Fiber Coax）系统
在这里使用的是电缆调制解调器（cable modem） 在这里和DSLAM相同作用的设施称为电缆调制解调器端接系统（Cable Modem Termination System，CMTS）
非对称信道

光纤到户（Fiber To The Home，FTTH）
主动光纤网络（Active Optical Network，AON）和被动光纤网络（Passive Optical Network，PON）
每个家庭有一个光纤网络端接器（Optical Network Terminator，ONT），它由专门的光纤连接到邻近的分配器（splitter）。该分配器把一些家庭集结到一根共享的光纤，该光纤再连接到本地电话和公司的中心局中的光纤线路端接器（Optical Line Terminator，OLT）。该OLT提供了光信号和电信号之间的转换，经过本地电话公司路由器和因特网连接。在家庭中，用户将家庭路由器与ONT相连，并且可以通过这台家庭路由器接入因特网。

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/picture/fa1cc1153a6496f89cad863c15732b0b.png" style="zoom:50%;" />

##### 2.企业接入
主要就是以太网和WIIFI，这个就放在后面第六章吧
##### 3.广域无线网接入
也是第六章见
#### 1.2.2物理媒体
导引型媒体（guided media）和非导引型媒体（unguided media）
对于导引型媒体，电波沿着固体媒体前行，对于非导引型媒体，电波在空气或外层空间中传播。
1.双绞铜线
2.同轴电缆
3.光纤
4.陆地无线电信道
5.卫星无线电信道

### 1.3网络核心
#### 1.3.1分组交换
在各种网络应用中，端系统彼此之间交换报文（message）。报文能够包含协议设计者需要的任何东西。报文可以执行一种功能，也可以包含数据。
为了从源端系统向目的端系统发送一个报文，源将长报文划分为较小的数据块称之为分组。

[^分组]: 网络专有名词。大多数[计算机网络](https://baike.baidu.com/item/计算机网络/18763?fromModule=lemma_inlink)都不能连续地传送任意长的数据，所以实际上网络系统把[数据分割](https://baike.baidu.com/item/数据分割/4395664?fromModule=lemma_inlink)成小块，然后逐块地发送，这种小块就称作分组（packet）。也有些书籍把分组定义为网络层的[协议数据单元](https://baike.baidu.com/item/协议数据单元/8226389?fromModule=lemma_inlink)。
这里课本上的描述倒是和百度百科上的蛮像的

1.存储转发传输（这里可能会有计算问题，应该只要不晕，应该不会出问题的，和流水线技术蛮像的）：交换机能够开始向输出链路传输该分组的第一个比特之前，必须接受到整个分组

计算的话一般使用这个公式，这是一个分组经过N条速率均为R的链路组成的路径链的时延：
$$
d_{端到端}=N\frac{L}{R}
$$
P个分组通过N条链路序列的时延：
$$
d_{端到端}=（P+N-1）\frac{L}{R}
$$
2.排队时延和分组丢失

这部分应该很简单，交换机具有有限的输出缓存（output buffer），当分组抵达时，它可以进行缓存，输出的速率也不是理想状态下的很快，此时也会出现排队时延，同时容纳的分组数有限，当出现特别多的分组时，对于不能缓存的分组将会进行抛弃，进行分组丢失或者说丢包（packet loss）。

3.转发表和路由选择协议
根据转发表进行转发 这个转发表是怎么得到的，在后面会说的

#### 1.3.2电路交换
电路交换个人觉得可以根据就是电视剧中的那种需要接线员的电话去理解就可以了，和那种很类似
在电路交换网络中，在端系统间通信会话期间，预留了端系统之间沿路径通信所需要的资源。
1.电路交换中网络的复用
电路通常会采用频分复用（FDM）和时分复用（TDM）这个，应该还记得吧
**这里有个点不是很懂，书上说，传输时间和链路数量无关，这里的链路好像指的是前面的那个N**
2.分组交换与电路交换的对比
一般来说选择分组交换而不失电路交换

#### 1.3.3网络的网络
当前采用层次结构的网络，第一层ISP，区域ISP与区域内的接入ISP。

PoP（Point of Presence）存在点：存在点存在于等级结构的所有层次，但是底层（接入ISP）等级除外。一个PoP只是提供商网络中的一台或多台路由器群组。其中客户ISP能够和提供商ISP连接。对于要与提供商PoP连接的客户网络，它能从第三方电信提供商租用高速链路作为他的路由器之一直接连接到位于该PoP的一台路由器。

多宿：任何ISP可以与两个或者更多供应商ISP连接。

对等：位于相同等级结构层次的邻近一对ISP能够对等。可以直接把他们之间的网络直接连接在一起，使他们之间的所有流量经直接连接而不是通过上游的中间ISP传输。当两个ISP对等时，通常不进行结算，也就是任一个ISP不向其对等付费。

IXP（Internet Exchange Point，因特网交换点）IXP是一个汇合点，多个IXP在这里对等。

再加入内容供应商网络后就可以实现今天的因特网

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/picture/c5341273044dee8d98bdbe02fc5aa3eb.png" alt="c5341273044dee8d98bdbe02fc5aa3eb" style="zoom:50%;" />

### 1.4分组交换网中的时延、丢包和吞吐量
#### 1.4.1分组交换网中的时延概述
大概重要的时延有节点处理时延（nodal processing delay）、排队时延（queuing delay）、传输时延（transmission delay）和传播时延（propagation delay）

看到这里应该就知道会在那里晕了吧，就是传输时延和传播时延

传输时延可以理解为把分组从交换机推向链路，而传播时延就是分组在链路上传输。

节点的总时延：
$$
d_{nodal}=d_{proc}+d_{queue}+d_{trans}+d_{prop}
$$
也就是总时延等于处理时延+排队时延+传输时延+传播时延
一般来说的话处理时延可以忽略不计，排队时延第二个忽略不计

#### 1.4.2排队时延和丢包

下式成为流量强度，L为分组的比特数，a为分组抵达队列的平均速率，R是传输速率
$$
\frac{La}{R}
$$
要求在设计系统时，流量强度不能大于1

随着流量强度接近1，平均排队时延迅速增加。该强度的少量增加将会引起时延大比列增加。

丢包：路由器队列已满，没有地方存储该分组，将会丢弃该分组

#### 1.4.3端到端时延
当不考虑排队时延时
$$
d_{end-end}=N(d_{proc}+d_{trans}+d_{prop})
$$
其中
$$
d_{trans}=L/R
$$
1.Traceroute

当用户指定一个目的主机名字时，源主机中的该程序朝着目的地发送多个特殊的分组。当这些分组向着目的地传送时，他们通过一系列路由器。当路由器接收到这些特殊分组之一时，它向源回送一个短报文，该报文包括路由器的名字和地址。

分组n发送到路由器n的往返时延实际上可能比分组n+1到路由器n+1的往返时延更长。

2.端系统、应用程序和其他时延。

#### 1.4.4 计算机网络中的吞吐量

端到端的吞吐量作为计算机网络中的一个重要的评价指标

瞬时吞吐量和平均吞吐量

当有多条链路时，吞吐量取决于瓶颈链路的传输速率

### 1.5 协议层次及其服务模型

#### 1.5.1分层的体系结构

只要某层对其上面的层提供相同的服务，并且使用来自下面层次的相同服务，当某层的实现变化时，该系统的其余部分保持不变。同时，改变服务的实现不会影响系统其他组件。

1.协议分层

各层的所有协议称为协议栈

五层结构模型    封装
（1）应用层   报文
（2)  传输层  报文段
（3）网络层 数据报
（4）链路层  帧
（5）物理层 比特

在ISO国际标准化组织提出的OSI模型中，计算机网络具有七层结构：
应用层 表示层 会话层 运输层 网络层 数据链路层和物理层

### 1.6面对攻击的网络
1.将有害程序放入你的计算机中
病毒（virus）是一种需要某种形式的用户交互来感染用户的恶意软件。
蠕虫（worm) 是一种无须任何用户交互就能够进入设备的恶意软件。 
2.攻击服务器和网络基础设施
主要是连接宽泛攻击：
DoS（Denial of Service,拒绝服务攻击）
DDoS（Distributed Denial of Service,分布式拒绝服务攻击）
3.嗅探分组
分组嗅探器（packet sniffer）
4.可以伪装成你熟悉的人

## 第2章 应用层

### 2.1应用层协议原理
研发网络应用程序的核心就是写出能够在不同的端系统和通过网络彼此通信的程序。
同时由于分层原理，我们只需要考虑应用软件在端系统上运行。

#### 2.1.1网络应用程序体系结构
客户-服务器体系结构 (client-server architecture)C/S体系结构
对等体系结构（peer to peer ，或者是point to point）P2P体系结构
P2P一个比较吸引人的地方是它的自拓展性（self-scalability）

#### 2.1.2 进程通信
运行在多个端系统商进行通信的实际是进程，一个进程可以被认为是运行在端系统中的一个程序。我们主要考虑的是在不同端系统上的进程间的通信。

1.客户和服务器进程
在一对进程之间的通信挥发场景中，发起通信(即在该会话开始时发起与其他进程的联系）的进程被标识为客户（client），在会话开始时等待联系的进程是服务器（server）
2.进程与计算机网络之间的端口
进程通过一个称为套接字（socket）的软件接口向网络发送报文和从网络接收报文。
套接字是同一台主机内应用层和运输层之间的接口。该套接字也可以称为应用程序和网络之间的应用程序编程接口（Application Programming Interface,API)
应用程序开发者可以控制套接字在应用层端的控制权。对运输层的控制权局限于：（1）选择运输层协议（2）也许可以设定几个运输层参数，如最大缓存和最大报文长度。
3.进程寻址

#### 2.1.3可供应用程序使用的运输服务
套接字是应用程序进程与运输层协议之间的接口。在发送端的应用程序将报文推进该套接字。在该套接字的另一侧，运输层协议负责从接受进程的套接字得到该报文。
1.可靠数据传输
2.吞吐量
吞吐量是，在沿着一条网络路径上的两个进程之间的通信会话场景中，可用吞吐量就是发送进程可以能够向接受进程交付比特的速率。
3.定时
4.安全性

#### 2.1.4 因特网提供的运输服务

这个地方感觉出现在这里属于出现早了，感觉可以在下一章出现，不过这也是这本书的特点。

1.TCP服务

TCP服务模型包括面向连接服务和可靠传输服务.TCP服务的连接是全双工的.TCP还具有拥塞控制机制.

提到了拥塞控制机制,可能此时会想起来流量控制,流量控制和拥塞控制有什么区别呢?
流量控制和拥塞控制的区别在于：流量控制是为了预防数据丢失，通过滑动窗口机制控制发送方的数据发送速率；拥塞控制是为了防止网络过载，通过慢开始、拥塞避免、快重传和快恢复策略来控制网络拥塞程度

2.UDP服务

UDP服务模型正好可以与TCP相反,它是无连接的,并且提供的是不可靠服务.

3.因特网运输协议所不提供的服务

我们所看到TCP提供了一种可靠稳定的方式去传输分组,那么是不是就不需要UDP呢?答案是否,TCP由于其拥塞控制,可能对与应用程序并不是一个利处.比如电话.

| 应用         | 应用层协议         | 支持的运输层协议 |
| :----------- | ------------------ | ---------------- |
| 电子邮件     | SMTP               | TCP              |
| 远程终端访问 | Telnet             | TCP              |
| 文件传输     | FTP                | TCP              |
| 流式多媒体   | HTTP               | TCP              |
| 因特网电话   | SIP,RTP,或者专用的 | UDP或UDP         |
| web          | HTTP               | TCP              |

####  2.1.5 应用层协议
应用层协议(application-layer protocol )定义了运行在不同端系统上的应用程序进程如何相互传递报文.

以web为例吧.web是一种客户-服务器应用.web应用有很多的组成部分,包括文档格式的标准(即HTML,超文本标记语言,Hyper Text Markup Language),web浏览器,web服务器,以及一个应用层协议.

### 2.2 Web和HTTP
#### 2.2.1HTTP概况
HTTP(Hyper Text Transfer Protocol,超文本传输协议).HTTP由两个程序进行实现:一个客户端程序和一个服务器程序.

Web页面(Web page)是由对象组成的.一个对象(Object)只是一个文档,他们可以通过URL(URL,Uniform Resource Locator,统一资源定位器)进行寻址.多数Web页面中含有一个HTML文件(base HTML file)以及几个引用对象.HTML文件通过对象的URL地址引用页面中的其他对象.每个URL由两部分组成:存放对象的服务器主机名和对象的路径名.

Web浏览器作为HTTP的客户端,Web服务器实现了HTTP的服务器端.

HTTP使用TCP作为它的支撑运输层协议.

注意到这个:HTTP作为一个无状态协议(stateless protocol),服务器向客户发送被请求的文件,而不存储任何关于该客户的状态信息.这里与下面的cookie有关

#### 2.2.2 非持续连接与持续连接
非持续连接(non-persistent connection):每个请求/响应对是经一个单独的TCP连接发送
持续连接(persistent connection):所有的请求/响应对经相同的TCP连接发送
其实这里也就是当本次请求和响应完成后,TCP连接会不会断开

HTTP既能顾使用非持续连接,也能够使用持续连接,HTTP在其默认方式下使用持续连接,HTTP客户和服务器也能配置成使用非持续连接.

1.使用非持续连接的HTTP
HTTP1.0是非持续连接
HTTP服务器进程通知TCP断开连接(但是直到TCP确认客户以及完整收到响应报文为止,连接才会实际中断)
所谓的非持续连接HTTP也就是,每个TCP连接只发送一个对象后关闭,该链接不为其他的对象而持续下来.
目前大部分的浏览器都可以打开多个并行的TCP连接
这里有引入了一个数:RTT(Round-Trip Time,往返时间),是指一个短分组从客户到服务器然后再返回客户所花费的时间.
TCP的三次握手,花费的时间是两个TCP加上服务器传输HTML文件的时间.

2.采用持续连接的HTTP 
HTTP1.1是持续连接
与上面的相反

#### 2.2.3 HTTP报文格式
1.HTTP请求报文

```html
GET/somedif/page.html HTTP/1.1
Host:www.someschool.edu
Connection:close
User-agent: Mozilla/5.0
Accept-language: fr
```

HTTP报文的第一行叫做请求行(request line)请求行有三个字段:方法字段,URL字段和HTTP版本字段
方法字段有GET,POST,HEAD,PUT,DELETE,绝大多数为GET,当请求以一个对象时,采用GET方法,在URL字段带有请求对象的标识.
其后继的行叫做首部行(header line)
Host首部行指明了对象所在的主机,Connection首部行指明了,是非持续连接,User-agent表明了用户代理,即向服务器发送请求的浏览器的类型,Accept-language:表明用户想接收到的语言版本

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/4c1008f24be7788972b0858466ecd12c.png" style="zoom:50%;" />

实体体:使用POST方法时,才使用实体体,当用户提交表单时,HTTP客户常常使用POST方法.
HEAD方法:当服务器收到使用HEAD方法的请求时,将会使用一个HTTP报文进行回应,但是并不返回请求对象.
PUT方法:上传    DELETE方法:删除

2.HTTP响应报文
```html
HTTP/1.1 200 OK
Connection:close
Date:Tue,18 Aug 2015 15:44:04 GMT
Server:Apache/2.2.3(Centos)
Last-Modified:Tue,18 Aug 2015 15:11:03 GMT
Connect-Length:6821
Content-Type:text/html
(data........)
```
响应报文包含:一个初始状态行(status line):有三个字段,协议版本字段,状态码和响应状态信息
首部行:这里解释一些GMT:格林威治标准时间
然后是实体体

| 状态码                         | 相关短语                                                     |
| ------------------------------ | ------------------------------------------------------------ |
| 200 OK                         | 请求成功,信息在返回的响应报文中                              |
| 301 Moved Permanently          | 请求的对象已经被永久转移了,新的URL定义在响应报文的Location:首部行中.客户软件将自动获取新的URL |
| 400 Bad Request                | 一个通用差错代码,指示该请求不能被服务器理解                  |
| 404 Not Found                  | 请求的文档不在服务器上                                       |
| 505 HTTP Version Not Supported | 服务器不支持请求报文使用的HTTP协议版本                       |

#### 2.2.4 用户和服务器的交互:cookie
HTTP协议是无状态的协议,但是考虑在实际应用中我们需要对应用程序的用户进行识别,我们需要对用户进行标识
cookie技术有4个组件:(1)在HTTP响应报文中的一个cookie首部行
(2)在HTTP请求报文中的一个cookie首部行
(3)在用户端系统保留一个有cookie文件,并由用户的浏览器进行管理
(4)位于web站点的一个后端数据库

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/154978613cf12c7756293331c0ec8476.png" style="zoom:50%;" />

cookie可以用于标记一个用户.

#### 2.2.5 Web缓存
Web缓存(Web cache)也叫做代理服务器(proxy server),他是能够代表初始web服务器来满足HTTP请求的网络实体.Web具有自己的磁盘存储空间,并在存储空间中保存最近请求过的对象的副本.
#### 2.2.6条件GET方法
和上面的Web缓存有关,缓存保存着最近请求过的对象的副本,但是不能保证这个副本是否为最新.
所以采用了条件GET方法:(1)请求报文使用GET方法(2)请求报文中包含一个"If-Modified-Since"首部行
在初次访问某个对象时,Web缓存并不具有对应的副本,他需要在Web服务器提供的对象中进行下载,然后得到.
在后续,Web缓存需要先向Web服务器发送一个条件GET进行检查
假设该对象没有被修改,那么,Web服务器会向Web缓存发送一个未带有所请求对象的响应报文
状态行304 Not Modified,他告诉缓存器可以使用该对象,能向请求的浏览器转发Web缓存存储的该对象的副本.

### 2.3因特网中的电子邮件

因特网电子邮件系统有3个主要组成部分：用户代理（user agent）、邮件服务器（mail server）和简单邮件传输协议（Simple Mail Transfer Protocol)

用户代理允许用户阅读、回复、转发、保存和撰写报文。

邮件服务器是电子邮件系统的核心。每个接收方在其中的某个邮件服务器上有一个邮箱（mailbox）。

描述一下简单的邮件发送过程：从发送方的用户代理开始，传输到发送方的邮件服务器，再传输到接收方的邮件服务器，然后在这里被分发到接收方的邮箱中。如果发送方的邮件服务器不能将邮件交付给接收方的邮件服务器，发送方的邮件服务器在一个报文队列（packet queue）中保持该报文并在以后尝试再次发送。通常30min左右进行一次尝试；如果几天后仍然不能成功，服务器将会以电子邮件的形式通知发送方。

SMTP使用TCP作为它的运输层传输协议，从发送方的邮件服务器向接收方的邮件服务器发送邮件。
#### 2.3.1 SMTP
SMIP（简单邮件传输协议）SMTP一般不使用中间服务器发送邮件，即使这两个邮件服务器相隔很远。
SMTP使用持续链接。

SMTP客户和SMTP服务器之间交换报文文本的例子。

```SMTP
S:220 hamburger.edu
C:HELO crepes.fr
S:250 Hello crepes.fr,pleased to meet you
C:MAIL FROM:<alice@crepes.fr>
S:250 alice@crepes.fr ....Sender ok
C:RCPT TO:<bob@hamburger.edu>
S:250 bob@hamburger.edu ...Recipient ok
C:DATA
S:354 Enter mail ,end with "." on a line by itself
C:Do you like ketcup?
C:How about pickles?
C:.
S:250 Message accepted for delivery
C:QUIT
S:221 hamburger.edu closing connection4
```
HELO 在这里是HELLO的缩写
#### 2.3.2 与HTTP协议的对比
1.HTTP是一个拉（pull）协议     SMTP是推(put)协议
2.SMTP协议要求每个报文采用7比特ASCLL码格式，如果某个报文包含了非7比特ASCLL字符或二进制数据，则该报文必须按照7比特ASCLL码进行编码。HTTP数据则不受这种限制
3.HTTP把每个对象封装到它自己的HTTP响应报文中。而SMTP则把所有报文对象放在一个报文中
#### 2.3.3 邮件报文格式
```SMTP报文
From:alice@crepes.fr
To:bob@hamburger.edu
Subject:Searching for the meaning of life.
```
#### 2.3.4邮件访问协议
这个地方还是比较简单就可以理解的，也就是邮件抵达接收方的邮件服务器之后，接收方需要采取怎么样的方式进行访问

1.POP3
当用户代理打开了一个到邮件服务器上端口110上的TCP连接后，POP3进行工作。POP3按照三个阶段进行工作：特许（authorization）、事务处理以及更新。

在特许阶段：用户代理发送（以明文形式）用户名和口令以鉴别用户。
在事务处理阶段：用户代理取回报文，同时在这个阶段，用户代理还可以对报文做删除标记，取消报文删除标记，以及获取邮件的统计信息。
在更新阶段：结束该POP3会话，同时邮件服务器会删除那些被标记为删除的报文

使用POP3的用户代理常被用户配置为“下载并删除”或者“下载并保留”方式。
使用下载并删除方式：
list：用户代理请求邮件服务器列出所有存储的报文长度
retr：从邮件服务器中取回邮件
dele：删除邮件
quit：结束连接
下载并保留：邮件服务器并不会删除邮件，而是保留在邮件服务器中。

2.IMAP
IMAP服务器将每个报文和一个文件夹联系起来；当报文第一次到达服务器时，它与收件人的INBOX文件夹相关联。收件人可以把邮件移到一个新的、用户创建的文件夹中，阅读邮件、删除邮件等。IMAP为用户提供了可以创建文件夹以及将邮件从一个文件夹移动到另一个文件夹的命令。IMAP还未用户提供了在远程文件夹中查询邮件的命令，按照指定条件去查询匹配的邮件。
IMAP同时还可以允许用户代理获取报文某些部分。

3.基于Web的电子邮件

使用HTTP协议从邮件服务器上进行拉动作

### 2..4 DNS:因特网的目录服务
根据主机名查询IP地址
#### 2.4.1DNS提供的服务

DNS（Domain Name System）

DNS是：（1）一个由分层的DNS服务器（DNS server）实现的分布式数据库
（2）一个使得主机能够查询分布式数据库的应用层协议
**DNS服务器通常是运行BIND（Berkeley Internet Name Domain)软件的UNIX机器 **
DNS协议运行在UDP运输层协议上，使用53号端口
DNS还提供别的服务：（1）主机别名（host aliasing）（2）邮件服务器别名（mail server aliasing)   (3)负载分配（load distribution）
#### 2.4.2DNS工作机理概述
1.分布式、层式数数据库
有三种类型的DNS服务器：根DNS服务器、顶级域（Top-Level Domian，TLD）DNS服务器和权威服务器
大概他们的作用，我们都可以想到，就不再赘述

本地域名服务器（local DNS server）起着代理的作用

这里需要注意的是递归查询和迭代查询，这个的区别，我感觉可以类似于数据结构里的，深度搜索和广度搜索，迭代类似于深度搜索，递归类似于深度搜素

2.DNS缓存
DNS缓存（DNS cache）可以将缓存保存在本地存储器中
DNS服务器会在一段时间后，将丢弃缓存的信息
本地域名服务器也能够缓存TLD服务器的IP地址，从而允许本地DNS服务器绕过根服务器。
#### 2.4.3 DNS记录和报文
资源记录（Resource Record，RR）
资源记录是一个包含下列字段的四元组：
（Name，Value，Type，TTL）
TTL是该记录的生存时间，它决定了资源记录应当从缓存中删除的时间
（1）Type=A  主机名到IP Name 主机名  Value IP地址
（2）Type=NS 域到主机名  Name 域名 Value 知道如何获取该域名中主机IP地址的权威DNS服务器的主机名
（3）Type=CNAME 别名到规范主机名  Name 别名 Value 规范主机名
（4）Type=MX 适用于邮件服务器的别名和规范主机名的转化 Name 别名 Value 邮件服务器的规范主机名

1.DNS报文

DNS只有查询和回答两种报文。并且这两种报文的格式相同。

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/e63e3e2359b8213f37db5b96da601be0.png" style="zoom: 50%;" />

前12字节是首部区域。

标识符是一个16比特的数，用于标识该查询。这个标识符会被复制到查询的回答报文中，以便于区让客户用它来匹配发送的请求和接收到的回答。

标志位用来指出该报文是查询报文（0）还是回答报文（1）

使用nslookup程序可以发送一个DNS查询报文

2.在DNS数据库中插入记录

### 2.5 P2P文件转发

1.P2P体系结构的扩展性

P2P是不是有一点之前看过的边缘计算 edge computing的味道

2.BitTorrent

BitTorrent是一个用于文件分发的流行P2P协议。

参与一个特定文件分发的所有对等方的集合被称为一个洪流（torrent）。他可能在接收到自己需要的文件之后，离开洪流，也有可能继续留在洪流中继续向其他对等方上载块。

每个洪流都具有一个基本设施节点，称为追踪器（tracker）。当一个对等方加入某洪流是，他向追踪器注册自己，并周期性地通知追踪器他仍在洪流中。

同时，对等方使用最稀缺优先得到技术（rarest first）。针对它没有的块，但是在他的邻居中最稀缺的块，首先接收这样的块。这样，最稀缺块得到更为迅速的重新转发，其目标是均衡每个块在洪流中的副本数量。

同时，他会选择出，当前副本传输最快的4个邻居，同时这4个集合可能会根据实际速率的变化，而作出修改，这个称为疏通（unchoked）

### 2.6 视频流和内容分发网

#### 2..6.1 因特网视频

#### 2.6.2 HTTP流和DASH
关于这个在后面的第九章进行了更为详细的探讨
#### 2.6.3 内容分发网
内容分发网（content distribution network，CDN）
1.一般有内容供应商自己拥有：专用CDN（private CDN）
2.还有就是多个内容分发商分发内容：第三方CDN（third-party CDN）

服务器的安置原则：
（1）深入。在遍及全球的接入ISP中部署服务器集群来深入到ISP的接入网中。
（2）邀请做客。通过在少量关键位置建造大集群来邀请到ISP做客，这些CDN通常将他们的集群放置在因特网交换点（IXP）。

1.CDN操作

CDN服务器会截获DNS请求，然后（1）确定此时适合用于该客户的CDN服务器集群（2)将客户的请求定位到该集群的某台服务器。

2.集群选择策略
（1）地理上最为临近
（2）实际测量选出最优

## 第3章 运输层

运输层将网络层在两个端系统之间的交付服务扩展到在两个不同端系统上的应用层进程之间的交付服务。

### 3.1 概述和运输层服务

运输层为运行在不同主机上的应用进程之间提供了逻辑通信功能。

我们注意到：由于网络路由器只有网络层、链路层和物理层，所以它们仅作用于该数据报的网络层字段；他们不检查封装在该数据包上的运输层报文段的字段。

#### 3.1.1 运输层和网络层的关系
网络层提供了主机之间的逻辑通信，而运输层为运行在不同主机上的进程之间提供了逻辑通信。

这里Ann和Bill的例子是可以看一下的，P122（对于对于理解一些概念）

运输协议能够提供的服务常常受制于底层网络层协议提供的服务模型。比如如果网络层协议无法为主机之间发送的运输层报文段提供时延或者带宽保证的话，运输层协议也无法为进程之间发送的应用程序报文提供时延或带宽保证。
但是也存在特殊状况，即使底层网络协议不能在网络层提供相应的服务，但是运输层也可以提供某些服务。比如TCP的可靠传输。
#### 3.1.2 因特网运输层概述
应该在前面说过吧
TCP 可靠，面向连接    UDP 不可靠，无连接

IP（Internet Protocol，网际协议）IP的服务模型是尽力而为交付服务（best-effort delivery service），IP提供的是不可靠服务。

那么UDP和TCP的服务模型是什么呢?

UDP和TCP最基本的责任是，将两个端系统间IP的交付服务拓展为在端系统上的两个进程之间的交付服务。将主机间交付拓展到进程间交付被称为运输层的多路复用（transport-layer multiplexing）和多路分解（transport-layer demultiplexing）
UDP仅负责进程到进程之间的数据交付和差错检查。
TCP除了上述之外，还具有可靠数据传输（reliable data transport）和拥塞控制（congestion control）的功能。

### 3.2 多路复用和多路分解
这个感觉理解之后还是很简单的
运输层到套接字  多路分解   套接字到运输层  多路复用

详细叙述：   在接收端，运输层根据运输层报文段中的几个字段，标识出接受套接字，进而将报文段定向到该套接字。将运输层报文段中的数据交付到正确的套接字的工作称为**多路分解。**
在源主机从不同套接字中收集数据块，并为每个数据块封装上首部信息从而形成报文段，然后将报文段传递到网络层，这被称为**多路复用**

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/18e7a16d156f9a248b30bba1c29746dc.png" style="zoom:33%;" />

我们可以看出可以根据报文端中的字段进行定位套接字。

端口号是一个16比特的数，其大小在0~65535之间。0~1023之间为周知端口号（well-known port number），是受限制的，他们邮件被分配给周知应用层协议来使用。

1.无连接的多路复用和多路分解

依靠一个目的地IP地址和一个目的端口号进行定位

**注意**：如果两个UDP报文段具有不同的源地址/或源端口号，但是具有相同的目的IP地址和目的端口号，那么这两个报文段将通过相同的目的套接字被定向到相同目的进程。

2.面向连接的多路复用和多路分解

依靠 源IP地址 源端口号 目的IP地址 目的端口号 来标识的

** 注意**：与上面的注意相反

套接字可以理解为IP地址+端口号

3Web服务器与TCP

注意：连接套接字与进程之间并非总是有着一一对应的关系。事实上，当前高性能Web服务器只是用一个进程，但是为每个新的客户连接创建一个具有新连接套接字的新线程。
### 3.3 无连接传输 UDP
我们应该在之前就讨论过，为什么相比较于UDP，TCP提供更为可靠，稳当的服务，那么我们为什么要使用UDP服务呢？
1.关于发送什么数据以及何时发送的应用层控制更为精细。
2.无须连接建立。
3.无连接状态
4.分组开销小。TCP的首部开销为20字节，而UDP仅有8字节的开销。

|      应用      | 应用层协议 | 下面的运输层协议 |
| :------------: | :--------: | :--------------: |
|    电子邮件    |    SMTP    |       TCP        |
|  远程终端访问  |   Telnet   |       TCP        |
|      Web       |    HTTP    |       TCP        |
|    文件传输    |    FTP     |       TCP        |
| 远程文件服务器 |    NFS     |     通常UDP      |
|   流式多媒体   |  通常专用  |     UDP或TCP     |
|   因特网电话   |  通常专用  |     UDP或TCP     |
|    网络管理    |    SNMP    |     通常UDP      |
|    名字转换    |    DNS     |     通常UDP      |

虽然说UDP提供的是不可靠服务，但是使用UDP的应用是可能实现可靠数据传输的。这可以通过在应用程序自身中建立可靠性机制来完成。把比如谷歌在Chrome浏览器中使用的QUIC（快速UDP因特网连接）协议。
#### 3.3.1 UDP报文段结构

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/225542bdd347926700e358869de0ddeb.png" style="zoom:33%;" />

长度字段指示了在UDP报文段中的字节数（首部+数据）。检验和用来差错检验。
#### 3.3.2 UDP检验和
端到端服务上提供差错检验  端到端原则（end-end principle）
虽然UDP可以提供差错检测，但是它对差错恢复无能为力。UDP的某种实现只是丢弃失损的报文段，其他实现是将受损的报文段交给应用程序并给出警告。

### 3.4 [可靠的数据传输原理](https://blog.csdn.net/Sqrt1230/article/details/121269131/)
（这个地方不好写啊）

先看下图：

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/c671d65ad7226ce9d6119cae42b9edd4.png" style="zoom:50%;" />

有限状态机（Finite-State Machine，FSM）
引起变迁的事件显示在表示变迁的横线上方，事件所采取的动作显示在横线下方。如果对于一个事件没有动作，或没有事件发生而采取了一个动作，我们将在横线下方或者下方使用符号Λ.
FSM的初始状态使用虚线表示。

停等协议（stop-and-wait protocol）需要等到接收方向发送方的反馈后，才会做出下一动作
使用了肯定确认和否定确认。使得接收方可以使发送方知道那些内容被正确接收，那些内容接收有误并因此需要重复。这个被称作** 自动重传协议（Automatic Repeat Protocol，ARQ）**
定时器会引入冗余分组（duplicate packet），可以通过序号来解决这一问题。
快速重传 ：收到三次冗余ACK，立即重传报文。

#### 3.4.3 回退N步
回退N步（GBN，Go Back To N），也称为滑动窗口协议（sliding-window protocol）
1.如果出现超时，发送方发送所有已发送但是还未被确认过的分组。
2.对nextsequm-base进行判断，与最大的窗口数进行比较，当小于时，继续发送
3.采用累计确认的方法，当收到接收方序号为N的ACK时，代表接收方已经成功接受了，前面序号的分组
#### 3.4.4 选择重传
选择重传（Select Repeat，SR）是在发送方和接收方都存在一个长度为N的窗口。
对于SR协议，窗口长度必须小于或者等于序号空间的一半。

### 3.5 面向连接的传输：TCP
#### 3.5.1 TCP连接
TCP连接在建立前，必须进行“握手"，然后才可以进行传输数据。
TCP连接时逻辑连接，在实际上是并不存在的。TCP所提供的是** 全双工服务 **，点到点的服务。
注意：在三次握手中，客户的第三个报文段可以承载有效载荷。

TCP在发送方和接收方都存在一个发送缓存（send buffer）和接收缓存（receive buffer）。TCP可以从缓存中去除并放入报文段中的数据数量受限于最大报文段长度（Maximum Segment Size，MSS），MSS通常根据最初确定的由本地发送主机发送的最大链路层帧长度（也就是最大传输单元（Maximum Transmission Unit，MTU））来设置。
注意：通常MTU 1500B ，MSS 1460B

#### 3.5.2 TCP报文段结构

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/2d454d806e79c4b8adf3fdcb8a565d42.png" style="zoom: 50%;" />

** TCP首部一般是20B，UDP是8B **

接收窗口：该字段用来流量控制，该字段可以指示接收方愿意接受的字节数量。
4比特的首部长度字段（header length field）：指示了以32比特的字位单位的TCP首部长度。由于TCP选项字段的原因，TCP首部的长度是可变的。
可选与变长的选项字段：该字段用于发送方和接收方协商最大报文段长度（MSS）时，或者在高速网络环境下用作窗口调节因子时使用。首部字段中还定义了一个时间戳选项。
还有一些字段：ACK比特用于指示确认字段中的值是有效的。RST、SYN和FIN比特用于连接建立和拆除。在拥塞通告中，使用了CWR和ECE比特。当PSH比特被置为时，就指示接收方应立即将数据交给上层。URG比特用来指示报文段里存在着被发送端的上层实体设置为”紧急“的数据。紧急数据的最后一个字节由6比特的紧急数据指针字段（urgent data pointer field)指出。当紧急数据存在并给出指向紧急数据尾指针的时候，TCP必须通知接收端的上层实体。

1.序号和确认号
确认号是期望收到的下一字节的序号。
提供累计确认机制（就不用再多介绍了吧）
2.Telnet
这里有一个比较有意思的词，回显
回显（Echo）就是显示正在执行的批处理命令及执行的结果等，位置是显示在屏幕上。
感觉就是指我键入了之后，在对方的电脑上显示了，然后同时结果也会显示在我的电脑上

#### 3.5.3 往返时间的估计与超时
1.估计往返时间
$$
EstimatedRTT=(1-a)·EstimatedRTT+a·SampleRTT
$$
SampleRTT为报文的样本RTT，EstimatedRTT是SampleRTT的均值
a一般为0.125,这种方法被称为指数加权移动平均（Exponential Weighed Moving Average，EWMA）

同时有定义了另外一个参数：RTT的偏差，DevRTT，用来估算SampleRTT一般会偏离EstimatedRTT的程度
$$
DevRTT=（1-β）·DevRTT+β·|SampleRTT-EstimatedRTT|
$$
β的推荐值为0.25

2.设置和管理重传事件间隔

超时间隔TimeoutInterval：
$$
TimeoutInterval=Estimated+4·DevRTT
$$
推荐的初始TimeoutInterval为1秒。同时，** 当出现超时时，TimeoutInterval值将会加倍，以免即将被确认的后续报文段过早出现超时。然而只要收到报文段之后并更新EstimatedRTT，就使用上述公式再次计算。
### 3.5.4 可靠数据传输
TCP在IP不可靠传输服务之上提供了一个可靠传输服务（reliable data transfer service）。TCP的可靠传输服务确保一个进程可以从其接收缓存中读出的数据流时无损坏的、无间隙的、非冗余和按序的数据流；即该字节流与连接的另一方端系统发送出的字节流时完全相同的。

TCP有三个事件：从上层应用程序接收到数据‘定时器超时和收到ACK
```TCP发送方简化
/*假设发送方不受TCP流量和拥塞控制的限制，来自上层数据的长度小于MSS，且数据传送只在一个方向进行*/
NextSeqNum=InitalSeqNumber
SendBase=InitalSeqNumber

loop(永远)：
{
switch（事件）
    事件：从上面应用程序接收到数据e
        生成具有序号NextSeqNum的TCP报文段
        if（定时器当前没有运行）
            启动定时器
        向IP传递数据报
        NextSeqNum=NextSeqNum+length（data）
        break
    
    事件：定时器超时
        重传具有最小序号但是仍未应答的报文段
        启动定时器
        break
    
    事件：收到ACK，具有ACK文段值y
        if（y>SendBase）{
        SendBase=y
           if(当前仍无任何应答报文段)
              启动定时器
        }
        break
        
}/*结束永远循环*/
```
SendBase是最早未被确认的字节的序号
同时这里仍然采用了累计确认（累计确认：TCP在结构到连续的有序数据包时，只发送一个确认段来确认收到的数据包的机制）

1.这里有一个比较有趣的情况

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/0e3b0bae043f79d0cb7305f6c5d56a9b.png" style="zoom:50%;" />

我们可以看到可能由于超时间隔设置过断亦或者别的原因，在接收方发送了ACK的基础上却仍然重新发送了报文段。这里需要注意的是：当超时时间发生时，主机A重传序号92的第一个报文段，并重启定时器。只要第二个报文段的ACK在新的超时发生以前到达，则第二个报文不会被重传。

2.超时间隔加倍
每当超时事件发生时，每次TCP重传都会将下一次的超时间隔设为先前值得两倍
假如定时器在另两个事件（收到上层应用的数据和收到ACK）中的任意一个启动时，TimeoutInterval由最近的EstimatedRTT和DevRTT推算得出。

3.快速重传
我们在上面应该已经说到了这个点了，也就是收到对相同数据的三个冗余ACK，就立即重传报文

这里我发现有个地方好像现在才懂
seq是当前报文段的序号，ack携带的是希望收到的下一个报文段的序号

#### 3.5.5 流量控制
这里看一下书上是怎么阐述流量控制和拥塞控制的
流量控制服务（flow-control service）以**消除发送方使接收方缓存溢出**的可能性。流量控制是一个速度匹配服务，即发送方的发送速率和接收方的应用程序读取速率相匹配。
TCP发送方也可能因为**IP网络的拥塞而被遏制**；这种形式的发送方的控制称为拥塞控制（congestion control）

这里还是比较推荐看书，我把一些觉得重要的东西写一下

假设主机B的接收缓存已经存满也就是当前的rwnd为零，在将rwnd=0通报给主机A之后，假设主机B没有任何数据要发送给主机A。因为主机B的应用进程将缓存清空，TCP并不会向主机A发送带有rwnd新值的报文段，就是TCP仅当他有数据或者确认要发使才会发送报文段给主机A。这样就形成了死锁。主机A不知道主机B有了新的缓存空间。为了解决这个问题，当主机B的接收窗口为0时，主机A继续发送只有一个字节数据的报文段。这些报文段将会被接收方确认。最终缓存将开始清空。并且确认报文里将包含一个非零的rwnd值。
在网上看，也有说，主机A会启动一个计时器，时间一到就会向主机B发送报文询问rwnd的值，若接收者仍然返回零窗口，则重置该计时器继续等待；若窗口不为0，则表明主机B的可以接收数据。

UDP并不提供·1流量控制，报文段由于缓存溢出可能在接收方丢失。
#### 3.5.6 TCP连接管理

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/4eefd5d8ca97a9553963802be3d4f0b2.png" style="zoom:50%;" />

在三次握手的第三个阶段可以在报文段负载中携带客户到服务器的数据。
**从三次握手的第三个阶段开始，报文段中的SYN就开始设置为0**

**终止连接**

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/7aa0d5fa1954bf414390ebfbf16d8a98.png" style="zoom:50%;" />

**客户TCP状态序列**



<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/10f4bff9c7dcb0d018d9ff681ba9e237.png" style="zoom: 50%;" />





**服务器端的TCP状态序列**

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/2931d2367e4e7de4d96b5c459539145f.png" style="zoom:50%;" />

### 3.5 拥塞控制原理
这一小节也不太好描述

#### 3.6.1 拥塞原因和代价
1.发送方必须执行重传以补偿因为缓存溢出而丢弃的分组
2.发送方在遇到大时延时所进行的不想必要重传将会引起路由器利用其链路带宽来转发不必要的分组副本。
3.在复杂的链路状况中，可能会出现下游路由丢弃报文段的情况，这样对上游路由器传输容量被浪费掉了。
#### 3.6.2 拥塞控制方法
1.端到端拥塞控制
2.网络辅助的拥塞控制

网络辅助的拥塞控制有两种方式：
1.直接网络反馈
由网络路由器发给传送方，采用了一种阻塞分组（choke pocket）的形式
2.经由接收方的网络反馈
路由器标记或更新从发送方流向接收方的分组中的某个字段来指示拥塞的产生，一旦收到一个标记的分组后，接收方就会向发送方通知该网络拥塞指示。

### 3.7 TCP拥塞控制
TCP采用的方法是让每一个发送方根据所感知到的网络拥塞程度来限制其能向连接发送的速率。
按照这样的思路去求解吧
1.一个TCP发送方如何限制它向其连接发送流量的速率呢？
2.一个TCP发送方如何感知从它到目的地之间的路径上存在拥塞呢？
3.当发送方感知到端到端的拥塞时，采用何种算法来改变其发送速率呢？

1.我们知道在流量控制那里，我们知道了rwnd，在这里，我们再次引入一个值，运行在发送方的TCP拥塞控制机制跟踪一个额外的变量，即拥塞控制窗口（congestion window，cwnd）
一般来说存在
$$
LastByteSent-LastByteAcke\leq min\{cwnd\ ,rwnd\}
$$
一般来说主要受限于cwnd

发送速率可以理解为是cwnd/RTT 字节/秒，可以通过调节cwnd的值，发送方因此能调整它向连接发送数据的速率。

2.我们把丢包当作表示，当丢弃的数据报会引起发送方的丢包事件（这里指的是，什么代表出现了丢包，即超时或者收到3个冗余ACK），发送方就认为在发送方到接收方的路径上出现了拥塞的指示。

3.当没有出现丢包时，即没有出现拥塞时，我们可以通过接收方对发送方的确认来增加窗口的长度（及其传输速率），因为TCP使用确认来触发（或计时）增大它的拥塞窗口长度，TCP被说成是自计时的（self-clocking）

下面是一些指导原则：
1.一个丢失的报文段意味着拥塞，因此当丢弃报文段时，应当降低TCP发送方的速率。
2.一个确认报文段指示该网络正向接收方交付发送方的报文段，因此，当对先前未确认报文段的确认抵达时，能增加发送方的速率。
3.带宽探测。为探测拥塞开始出现的速率，TCP发送方增加它的传输速率，从该速率开始后退，进而再次开始探测，看看用拥塞开始速率是否发生了变化。

**TCP拥塞控制算法（TCP congestion control algorithm）**
包含三个主要部分：1.慢启动2.拥塞避免3.快速恢复

1.慢启动
每次翻一番
当出现这样的结果时，表示结束
（1）如果存在一个丢包事件，TCP发送方将cwnd设置为1斌重新开启慢启动过程。他还将第二个状态变量的值ssthresh（“慢启动阈值”的速记）设置为cwnd/2
（2）直接与ssthresh的值相关联。当检测到拥塞时ssthresh设为cwnd一半。当到达ssthresh的值时，结束慢启动并且TCP转移到拥塞避免模式。
（3）检测到3个ACK

2.拥塞避免
对于TCP发送方无论何时到达一个新的确认，就将cwnd增加一个MSS（MSS/cwnd)字节
当出现这样的结果时，表示结束
（1）当出现超时时，TCP发送方的cwnd值被设置为1个MSS，当丢包事件出现时，ssthresh的值被更新为cwnd的值的一半。
（2）针对快速重传出现的丢包情况，有着专门的处理方法：TCP将cwnd的值减半，并且当受到三个冗余ACK，将ssthresh的值记录为cwnd的一半，接下来进入快速恢复模式

3.快速恢复
对于收到的每个冗余ACK，cwnd的值增加一个MSS，最终，当对丢失报文的一个ACK达到时，TCP在降低cwnd后进入拥塞避免状态
（1）如果出现超时事件，快速恢复在执行如同在慢启动和拥塞避免中的相同动作惠普，迁移到慢启动状态
（2）当丢包事件出现时，cwnd的值被设置为1个MSS，并且ssthresh的值设置为cwnd值的一半。

** ssthresh为慢启动阈值**

4.TCP拥塞控制：回顾
要说这里的这张图挺有意思的

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/1728027525091.png" style="zoom:50%;" />

5.对TCP吞吐量的宏观描述
一条连接的平均吞吐量：
$$
一条链路的平均吞吐量=\frac{0.75×W}{RTT}
$$
这里的W是指窗口长度w字节

6.经高带宽路径的TCP

一条连接的平均吞吐量：
$$
一条链路的平均吞吐量=\frac{0.75×MSS}{RTT\sqrt{L}}
$$
丢包率 L         往返时间 RTT    MSS为最大报文长度

#### 3.7.1 公平性
瓶颈链路是指对于每条链接，沿着该链接路径上的所有其他段链路都不拥塞，而且与该瓶颈链路的传输容量相比，他们都具有充足的传输容量。
如果每条连接的平均传输速率接近平均值，即每条链路得到相同份额的链路带宽，则认为该拥塞控制机制时公平的。

#### 3.7.2明确拥塞通告：网络辅助拥塞控制
明确拥塞通告（Explicit Congestion Notification，ECN）

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/1728028262698.png" style="zoom:50%;" />

接收主机中的TCP会受到路由器传递的一个ECN拥塞指示，然后接收主机中的TCP通过在接收方到发送方的TCP ACK报文段中设置ECE比特，通知发送主机中的TCP收到拥塞指示。接下来，TCP发送方做出反应。

## 第4章 网络层：数据平面
数据平面功能，即网络中的每一台路由器的功能，该数据平面功能决定到达路由器输入链路之一的数据报（即网络层的分组）如何转发到该路由器的输出链路之一。
网络层的控制平面的功能，控制数据报沿着从源主机到目的主机端到端路径中路由器之间的路由方式。

其实可以概括不看上面那些，就是数据平面考虑转发，控制平面考虑路由选择。
### 4.1 网络层概述
每台路由器的数据平面功能的主要作用是从其输入链路向其输出链路转发数据包；控制平面的主要作用是协调这些本地的每路由器的转发动作，使得数据报沿着源和目的地主机之间的路由器最终进行端到端传送。
#### 4.1.1 转发和路由选择：数据平面和控制平面
转发和路由选择
转发（forwarding）：将分组从一个输入链路接口转移到适当的输出链路接口的路由器本地动作。该动作通常由硬件来实现。
路由选择（routing）：确定分组从源到目的地所采取的端到端路径的网络范围处理过程。通常使用软件来实现。

转发表（forwarding table）
转发表的配置
1.传统方法：在路由器中运行路由选择算法，在一台路由器中的路由选择算法与在其他
路由器中的路由选择算法通信，以计算出它的转发表的值。
2.控制平面：SDN方法（software-Defined Network，软件定义网络）
由远程控制器负责计算并分发转发表。

#### 4.1.2 网络服务模型
因特网的网络层提供了单一的服务，称之为尽力而为服务（best-effort service）

在这里我们对于分组交换机的概念做出说明。
分组交换机是指一台通用分组交换设备，它根据分组首部字段中的值，从输出链路接口到输出链路接口转移分组。某些分组交换机称为链路层交换机（link-layer switch）是，基于链路层帧中的字段值做出转发决定。某些交换机称为路由器，基于网络层数据报中的首部字段值做出转发决定。

### 4.2 路由器工作原理
<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/66c8ca447c1a7dc7c8ca5b1cd48d1201.png" style="zoom:50%;" />

1.输入端口（input port）。他在路由器中执行终结入物理链路的物理层功能，这显示在输入端口最左侧的方框与输出端口部分最右侧的方框中。他还要与位于链路远端的数据链路层交互来执行数据链路层功能，折现是自艾输入与输入端口部分中间的方框中。输入端口最右侧的方框中还要执行查找功能。

这里的“端口”，指的是路由器的物理输入和输出接口，这与我们之间在运输层中所提到的目的端口和源端口这些不同。

2.交换结构。交换结构将路由器的输入端口连接到它的输出端口。

3.输出端口。输出端口存储从交换结构接收的分组，并通过执行必要的链路层和物理层功能在输出链路上输出这些分组。

4.路由选择处理器。路由选择处理器执行控制平面功能。在传统的路由器中，它执行路由选择协议。维护路由选择表与关联链路转状态信息，并为该路由器计算转发表。在SDN路由器中，路由选择处理器负责与远程控制器通信，目的是接收由远程控制器计算得到的转发表项。路由选择处理器还指行网络管理管理功能。

#### 4.2.1 输入端口处理和基于目的地转发
转发表是由路由选择处理器计算和更新的（使用路由选择协议与其他网络路由中的路由选择处理器进行交互），或者转发表接收来自远程SDN控制器的内容。转发表从路由选择处理器经过独立总线复制到线路卡（也就是上图中的虚线）

这里的转发执行最长匹配前缀规则（longest prefix matching rule）：在该表中寻找最长的匹配选项，并向与最长前缀匹配相关联的链路接口转发分组。

在某些设计中，如果来自其他输入端口的分组当前正在使用该交换结构，一个分组可能会在进入交换结构中被暂时阻塞。因此，一个被阻塞的分组必须要在输入端口处排队，并在等待稍后被及时调度以通过交换结构。
在查找时，伴随着其他的动作。（1）必须出现物理层和链路层处理（2）必须检查分组的版本号、检验和以及寿命字段，并且重写后两个字段（3）必须更新用于网络管理的计数器

#### 4.2.2 交换
交换机采用的交换技术:
<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/492a7e36a336244d79be71218bcb547f.png" style="zoom:75%;" />
经内存交换：在路由选择控制器的直接控制下完成的
经总线交换：没有路由选择控制器的参与，在输入端口会为分组计划一个交换机内部标签，然后，这个分组会抵达所有的输出端口，但是只有与该标签匹配的端口才可以保存在分组，然后标签在输出端口被去除
经互联网络交换：是非阻塞的

#### 4.2.3 输出端口处理
<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/76a5fc9b01db533d5175a849df7ed56d.png" style="zoom: 67%;" />

#### 4.2.4 何时出现排队
1输入排队
可能会出现在一个输入队列中排队的分组必须等待通过交换结构发送，因为他被位于线路前端的另一个分组阻塞着，这个叫做输入排队交换机中的线路前部（Head-Of-the-Line）阻塞
2.输出排队
当出现没有足够的内存来缓存一个分组时，就必须要做出一个决定：要么丢弃到达的分组，采用一种称为弃尾（drop-tail）的策略，要么删除一个或多个已排队的分组为新来的分组腾出空间。
当然也可以采取这样的方法：在某些情况下，可以在缓存满之前就便丢弃一个分组（或者在其首部加上标记）的做法，来向发送发提供一个拥塞信号。这样类似的策略称为主动队列管理（Active Queue Management，AQM）算法.随机早期检测（Random Early Detection，RED）算法是得到最广泛研究和使用的算法之一。

#### 4.2.5 分组调度
1.先进先出
就像它的名字一样，先进先出（FIFO，First-In-First-Out）也成为先来先服务（FCFS，First-Come-First-Served）

2.优先权排队
在优先权排队（priority queuing）规则下，到达输出链路的分组被分类放入输出队列中的不同优先权类，然后再同一优先权类的分组之间的选择采用FIFO方式完成。
在非抢占式优先权排队（non-preemptive priority queuing）规则下，一旦分组开始传输,就不能打断。

3.循环和加权公平排队
在循环排队规则（round robin queuing discipline）下，分组像使用优先权排队那样被分类，然而，在类之间不存在严格的服务优先权，循环调度器在这些分类之间轮流提供服务。
一个所谓的保持工作排队（work-conserving queuing）规则在有（任何类的）分组排队等待传输时，不允许链路保持空闲。当寻找给定类的分组但是没有找到时，保持工作的循环规则将立即检查循环序列中的下一个类。
一种通用形式的循环队列，加权公平排队（Weighed Fair Queuing，WFQ）。它遵循保持工作排队原则。

**注意**：WFQ和循环排队的不同之处在于，每个类在任何时间间隔内可能收到不同数量的服务。每个类i被分配一个权值w<sub>i</sub>。使用WFQ方式，在类i有分组要发送的任何时间间隔中，第i类将确保接收到的服务部分等于
$$
w_i/\sum w_j
$$
式中分母中的和时计算所有有分组排队等待传输的类别得到的，在最坏的情况下，即使所有的类都有分组排队，第i类仍然保证分配到带宽的
$$
w_i/\sum w_j
$$

 （这里存在一个问题，我不会打行间公式，只能注意用公式来代替）

### 4.3  网际协议：IPv4、寻址、IPv6以及其他
#### 4.3.1 IPv4数据报格式
<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/8f9b2017aa5d2417eaa832af2f866f6f.png" style="zoom:50%;" />

（1）版本：这4比特规定了数据报的IP协议版本
（2）首部长度：还是由于选项的存在，需要通过这4比特来确定IP数据包中载荷实际开始的地方。由于大部分的IP数据报不具有选项，因此一般的IP数据报具有20字节的首部。
（3）服务类型：服务类型（TOS）比特包含在IPV4首部中，以便不同类型的IP数据报能相互区别开来。
（4）数据报长度：IPV4数据报的总长度，为首部加上数据。
（5）标识、标志、片偏移
（6）寿命。寿命（Time-To-Live，TTL），当TTL为0时，必须丢弃该数据报。
（7）协议：需要将数据报传递给那个协议
（8）首部检验和：首部检验和用于帮助路由器检测收到的IP数据报中的比特错误。

可能这里会出现一个问题，为什么TCP/IP在运输层和网络层都执行差错检测呢？
1.在IP层只对IP首部计算了检验和，而TCP/UCP检验和是对整个TCP/UDP报文段进行的。
**2.TCP/UDP与IP不一定都必须属于一个协议栈**

（9）源和目的IP地址
（10）选项
（11）数据

#### 4.3.2 IPV4数据报分片

一个链路层帧能承载的最大数据量叫做最大传送单元（Maximum Transmission Unit，MTU），MTU的大小会限制IP数据报的长度（这个我们在前面那个MSS哪里就见过的）。同时，在发送方与目的路径上的每段链路可能使用不同的链路层协议，并且每种协议可能具有不同的MTU。

因此需要对IPV4数据报进行分片（fragment）。片在目的地运输层以前需要重新组装。同时，这个这个数据报的重组工作放在了端系统中。

关于重组，上面的字段（5）标识、标志、片偏移就起到了作用。当生成一个数据报时，发送主机在为该数据报设置源和目的地址的同时贴上标识号。发送主机通常将他发送的每个数据包的标识号加1。当某路由器需要对一个数据报分片时，形成的每个数据报（即片）具有初始数据包的源地址、目的地址与标识号（这段话可能会有不同理解，你留意一下，多读几遍）。
为了使目的主机确认他已经收到了初始数据包的最后一个片，最后一个片的标志比特被设置为0，而所有其他片的标志比特被设置为1。另外为了让目的主机确认他是否丢失了一个片（且能按照正确的顺序重新组装片），使用偏移字段指定该片一个放在初始IP数据报的那个位置。
#### 4.3.3 IPV4编址
主机、路由器、交换机与链路之间的边界叫做接口（interface）。从技术上来说，一个IP地址与一个接口相关联，而不是与包括该接口的主机或路由器相关联。
子网掩码是指 /24这些

为了确定子网，分开主机和路由器的每个接口，产生几个隔离的网络岛，使用接口端接这些隔离的网络的端点。这些隔离的网络中的每一个都叫做子网（subnet）

无类别路由选择（Classless Interdomain Routing ，CIDR）这个就是和那个A、B、C、D那样划分相对的。
a.b.c.d/x这个被划分了两个部分，第一个网络部分，第二个就是主机。x指示了地址的第一部分中的比特数。这x最高比特构成了IP地址的网络部分，并且经常被称为改地址的前缀（prefix）（或者是网络前缀）剩下的32-x位比特可以认为是用来区分该组织内部设备的，其中的所有设备具有相同的网络前缀。
这样划分的广播地址为255.255.255.255，广播也就是该报文会交付到同一个网络中的所有主机。

地址聚合（address aggregation）、路由聚合（route aggregation）、以及路由摘要（route summarization）这三个词都是一个意思，应该知道是什么意思把。

1.如何获取一块地址

可以从ISP处获得IP地址。
IP地址有由因特网名字和编号分配机构（Internet Corporation for Assigned Names and Numbers，ICANN）管理。非营利的ICANN组织的作用不仅是分配IP地址，管理DNS服务器。它还具有一项分配域名和解决域名纷争的功能。ICANN向区域因特网注册机构分配地址，这些机构一起形成了ICANN的地址支持组织，处理本区域的地址分配/管理。

2获取主机地址：动态主机配置协议

动态主机配置协议（Dynamic Host Configuration Protocol，DHCP）。DHCP允许主机自动获取一个IP地址。**网络管理员可以配置DHCP，以使某给定主机每次与网络连接时能得到一个相同的IP地址，或者某主机将被分配一个临时的IP地址，每次与网络连接时该地址也许是不同的。**DHCP还允许主机得到别的信息，比如子网掩码，它的第一跳路由器地址（常称为默认网关）与他的DNS服务器地址。
由于DHCP具有将主机连接进一个网络的网络相关方面的自动能力，故他也可以称为即插即用协议）plug-and-play protocol）或者零配置（zeroconf）协议。

DHCP是一个客户-服务器协议。客户往往是新到达的主机，他要获得包括自身使用的IP地址在内的网络配置信息。在简单处理的情况下，每个子网中有一台DHCP服务器，如果在某子网中没有服务器，则需要一个DHCP中继代理（通常是一个路由器），这个代理知道用于该网络的DHCP服务器的地址。

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/4011eb4972bd18e81cf23260e2769d15.png" style="zoom:50%;" />

1.DHCP服务器发现：新到达的主机使用DHCP发送报文（DHCP discover message）来完成，客户在UDP分组中向端口67发送该发现报文。该UDP分组封装在一个IP数据报中。
2.DHCP服务器提供：服务器使用DHCP提供报文（DHCP offer message）做出响应，该报文向该子网中的所有节点进行广播。每台服务器提供的报文中包含有收到的发现报文的事务ID（transaction ID）、向客户推荐的IP地址、网络掩码以及IP地址租用期（address lease time），即IP地址有效的时间量。服务器租用时期通常设置为几个小时或者几天。
**注意**：为什么使用广播呢？
因为在子网中可能存在着几个DHCP服务器，该客户也许会发现它处于能在几个提供者之间进行选择的优越位置。
3.DHCP请求：客户对从一个或者几个服务器提供中选择一个，并向选中的服务器发送提供用DHCP请求报文（DHCP request message），回显配置的参数。
4.DHCP ACK：对DHCP请求报文进行响应，证实所要求的参数。

更多情况请见下图：
<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/b2c3d06f6160e2ab1259eea5abf1cc52_720.jpg" style="zoom: 33%;" />

#### 4.3.4 网络地址转换
网络地址转换（Network Address Translation，NAT）
NAT可以使路由器对外界隐藏了内部网络的细节。他会对于外界的源地址和外界对它的目的地址将会是一个新的地址，这个地址如何得到呢，是DHCP，路由器从ISP的DHCP服务器得到这个地址，并且路由器运行y一个DHCP服务器，为位于NAT-DHCP路由器控制的内部网络地址空间中的计算机提供地址。



<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/f24d9baa3f0c83fe7b5d7ed2a24d3c5a.png" style="zoom:50%;" />

这种类似的题也是做过的，所以应该懂吧？
**注意：**在图中，我们还可以看出端口号也发生了改变

#### 4.3.5 IPv6
IPv4不够用了
1.IPv6数据报格式

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/8e69fed2620cf7f2d8659808022eef6b.png" style="zoom: 80%;" />

IPv6有128位比特，足够使用了。同时IPv6在还引入了任播地址（anycast address）
1.简化高效的40字节首部。
2.流标签：IPv6有一个特殊的流（flow）定义。该字段值可以用于**“给属于特殊流的分组加上标签，这些特殊流是发送方要求进行特殊处理的流，如一种默认服务质量或需要实时服务的流”**
3.版本： IPv6这4比特字段值为6.
4.流量类型 8比特
5.流标签：这20比特的字段用于标识一条数据报的流，能够对一个流中的某些数据报给出优先权，或者它能够用来对来自某些应用的数据报给出更高的优先权，以优于来自其他应用的数据报。
6.有效载荷长度：16比特，给出了IPv6数据报中跟在定长的40字节数据报首部后面的字节数量
7.下一个首部：交付给那个协议
8.跳限制：和TTL差不多
9.源地址和目的地址
10.数据

2.从IPv4到IPv6的迁移
建隧道（tunneling）实现从IPv4到IPv6的迁移
将IPv6数据报放在一个IPv4数据报中的数据字段中，然后在接收方的IPv6节点可以通过观察该IPv4数据报中的协议号字段是41，了解到该IPv4有效载荷是IPv6数据报。

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/8ff016041f860371e5c9a625c66f4c11.png" style="zoom: 67%;" />

### 4.4 通用转发和SDN
这个感觉有印象就好了，先不写了（偷懒，日后有空会写的）
这一部分讲的是流表这个知识点，先略过

## 第5章 网路层:控制平面
### 5.1 概述



在本章中，我们主要学习转发表和流表是如何计算、维护和安装的。

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/48e491a693c3b488728c827709bf105a.png" style="zoom:50%;" />

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/1c1595ae252a60fcd1d1185b9f8fe879.png" style="zoom:50%;" />



1.每路由器控制。在第一张图中我们可以看到，在每一台路由器中都运行一种路由选择算法。每台路由器中都包含着转发和路由选择功能。每台路由器中有一个路由选择组件，用于和其他路由器中的路由选择组件进行通信，以计算其转发表的值。
2.逻辑集中式控制。在第二张图，有一个完全分开的**逻辑集中式**路由选择控制器。该控制器经一种定义良好的协议与每台路由器中的一个控制代理（CA）进行交互，以配置和管理该路由器的转发表。CA的功能是与控制器通信并且按控制器命令行事。CA既不能直接相互交互，也不能主动参与计算转发表。

### 5.2 路由选择算法
路由选择算法（routing algorithm）的目的是从发送方到接收方的过程中确定一条通过路由器网络的好的路径（等价于路由）。通常一条好的路径往往是指具有最低开销的路径。
这里采用的东西就是图里面的东西，感觉。

有下面两大类：

1.集中式路由选择算法（centralized routing algorithm）:用完整的、全局性的网路知识计算出从源到目的地之间的最低开销路径。也就是说，该算法以所有节点之间的连通性及所有链路之间的最低开销为输入。具有全局状态信息的算法常被乘坐链路状态（Link State，LS）算法，因为该算法必须知道网络中每条链路的开销。
2.分散式路由选择算法（decentralized routing algorithm）：路由器以迭代、分布式的方式计算出最低开销路径。没有节点拥有关于所有网络链路开销的完整信息。相反，每个节点在仅有与其直接相连链路的开销知识即可开始工作。然后，通过迭代计算过程以及与相邻节点的信息交换，计算出到达目的节点或一组目的节点的最低开销路径。这样称为距离向量（Distance-Vector,DV）算法的分布式路由选择算法，因为每个节点维护到网络中所有其他节点的开销（距离）估计的向量。

第二种分类是根据算法是静态还是动态的来分类。在静态路由的选择算法（static routing algorithm）中，路由随时间的变化非常缓慢。通常是由人工进行调整。动态路由选择算法（dynamic routing algorithm）随着网络流量负责或拓扑结构发生变化而改变路由选择路径。一个动态算法可周期性地运行或直接响应拓扑或链路开销的变化而运行。动态算法易于对网络的变化做出反应，因此也更容易收到诸如路由选择循环、路由振荡之类问题的影响。

第三种是根据它是负载敏感的还是负载迟钝的进行划分。在负载敏感算法（load-sensitivealgorithm），链路开销会动态地变化以反映出底层链路地当前拥塞水平。如果当一条链路与高开销相联系，则路由选择算法趋向绕开该拥塞路由来选择路由。当今的因特网路由选择算法（如RIP，OSPF，BGP）都是负载迟钝的，因为某条链路的开销不明确地反应其当前的拥塞水平。

#### 5.2.1 链路状态路由选择算法
首先可以通过让每个节点向网络中所有其他节点广播链路状态分组来使得网络拓扑和所有链路的开销在每个节点中都是可知的。其中的每个链路状态分组包含它连接的链路的标识和开销。这个经常通过链路状态广播（link state broadcast）算法来完成。

这里使用Dijkstra算法来完成的（如果你现在还对学的数据结构有印象的话，那么你应该就会发现这里使用的是在图中求得从一个顶点到其余个点的最短路径）

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/526c338a6ad18edc6fad79c5082694cf.png" style="zoom:50%;" />

图中的链路开销等于链路上承载的负载。按照图示的条件，会发生振荡，如何避免这样的震荡呢？（1）可以强制链路中的开销不依赖于所承载的流量，但是这样就不能避免高度拥塞的链路。（2）确保并非所有的路由器以相同周期来运行LS算法。

#### 5.2.2 距离向量路由选择算法
这里是使用了Bellman-Ford算法。（其实这里我蒙了，因为我记得学过了Dijstra，Floyd，Prim，Kruskal我感觉这几个的差别也不是很大啊）

可以看下一这个清醒一下  [图的经典四大算法-Prim和Kruskal,Dijkstra和Floyd算法_prim和kruskalfloyd-CSDN博客](https://blog.csdn.net/weizhifei1234/article/details/89073984#:~:text=二.算法简介. 对于)   和这个 [图论常见算法总结——prim,kruskal,dijkstra,floyed,bellman-ford,spfa_图论算法汇总-CSDN博客](https://blog.csdn.net/Se_ren_di_pity/article/details/139590987#:~:text=1.Bellman-)

从邻居接收更新距离变量、重新计算路由选择表项和通知邻居到目的地的最低开销路径的开销已经变化的过程继续下去，直到无更新报文发送为止。到这个时候，因为无更新报文发送，将不会出现进一步的路由选择表计算的，该算法进入静止状态。该算法停留在静止状态，直到一条链路开销发生改变，如下面讨论的情况一样：
1.距离向量算法：链路开销改变与链路故障
这一部分书上讲的很好，要是我说的话，就是由于每个节点已知的信息只能从相邻的节点获取，所指的信息不同步，导致的。

2.距离向量算法：增加毒性逆转
毒性逆转（poisoned reverse）
这里也是看书为好，写一段话
毒性逆转问题解决了一般的无穷计数问题吗？没有。你应认识到涉及3个或更多节点（而不只是两个直接相邻的邻居节点）的环路将无法用毒性逆转技术检测到。

3.LS和DV路由选择算法的比较
（1）报文复杂性：在LS算法中，要求每个节点都知道网络中每条链路的开销。这就要求发送O（|N|||E|）个报文，而且无论何时一条链路的开销改变时，必须要向所有的节点发送新的链路开销。DV算法要求在每次迭代时，在两个直接相连邻居之间交换报文。我们注意到，当链路开销改变时，DV算法仅当在新的链路开销导致与该链路相连节点的最低开销路径发生改变时，才传播已改变的链路开销。
（2）收敛速度：LS算法的实现是一个要求O（|N||E|）个报文的O（|N|^2^）算法。DV算法收敛速度较慢，且在收敛时会遇到路由选择环路。DV算法还会遇到无穷计数的问题。
（3）健壮性：在LS算法中，路由计算在某种程度上是分离的，提供了一定程度上的健壮性。在DV算法中，一个不正确的节点计算值会扩散到整个网路。

### 5.3 因特网中自治系统内部的路由选择：OSPF
每个自治系统（Autonomous System，AS）由一组通常处在相同管理控制下的路由器组成。通常在一个ISP中的路由器以及互联他们的链路构成一个AS。然而，某些ISP将它们的网络划分为多个AS。特别是，某些一级ISP在其整个网络中使用一个庞大的AS，而其他ISP则将他们的ISP'拆分为数十个互联的AS。一个自治系统由其全局唯一的AS号（ASN）进行标识。这里的AS号也由ICANN区域注册机构进行分配。
在自治系统内部执行的是路由选择算法叫做自治系统内部路由选择协议（intra-autonomous system routing protocol）

开放最短路径优先（OSPF，Open Shortest Path  First)
OSPF是一种链路状态协议，它使用洪泛链路状态信息和Dijkstra最低开销路径算法。使用OSPF时，路由器向自治系统内所有其他路由器广播路由选择信息。当一条链路的状态发生变化时，路由器就会广播链路状态信息。即使链路状态未发生变化，他也要周期性（至少每隔30min一次）广播链路状态。OSPF通告包含在OSPF报文中，该OSPF报文直接由IP承载，对OSPF其上层协议的值为89。OSPF还可以向相连的邻居通过发送HELLO报文来检查链路正在运行。

OSPF的有点包含：
（1）安全。能够鉴别OSPF路由器之间的交换。只有受信任的路由器可以参与一个AS内的OSPF协议（2）多条相同开销的路径。当到达某目的地的多条路径具有相同的开销时，OSPF允许使用多条路径。（3）对单播和多播路由选择的综合支持。（4）支持在单个AS中的层次结构。（这个重要的）一个OSPF自治系统能够层次化地配置多个区域。每个区域都运行自己的OSPF链路状态路由选择算法，区域内的每台路由器都向该区域内的所有其他路由器广播其链路状态。在每个区域内，一台或多台区域边界路由器负责流向该区域以外的分组提供路由选择。最后，在AS中只有一个OSPF区域配置成主干区域。主干区域的主要作用是为该AS中其他区域之间的流量提供路由选择。主干区域总是包含本AS中的所有区域边界路由器，并且还可能包含了一些非边界路由器。在AS中的区域间的路由选择要求分组先路由到一个区域边界路由器（区域内路由选择），然后通过主干路由到位于目的区域的区域边界路由器，进而在路由到最终目的地。

### 5.4 ISP之间的路由选择：BGP
在自治系统间执行的是自治区域间路由选择协议（inter-autonomous system routing protocol）
在因特网中，所有的AS运行相同的AS间路由选择协议，称为边界网关协议（Broder Gateway Protocol，BGP）
BGP协议将因特网中数以千计的ISP黏合起来。BGP是一种分布式和异步的协议，它是距离向量路由选择协议。
#### 5.4.1 BGP的作用
在BGP中，分组并不是路由到一个特定的目的地址，相反是路由到CIDR（Classless Inter Domain Routing,无类别域间路由)化的前缀，其中每个前缀表示一个子网或者一个子网的集合。因此，一台路由器的转发表将具有形式为（x，I）的表象，其中x是一个前缀，往往代表一个路由聚合，I是该路由器的接口之一的端口号。

作为AS之间的路由选择协议，BGP为每台路由器提供了一种完成以下任务的手段：
1)从邻居AS获得前缀的可达性信息。特别是，BGP允许把每个子网向因特网的其余部分通告它的存在。
2)确定到该前缀的“最好的”路由。一台路由器可能知道两条或者更多条到特定前缀的不同路由。路由器可以在本地运行一个BGP路由选择过程确定最好的路由。

#### 5.4.3 通告BGP路由信息
对于每个AS，每台路由器是一台网关路由器（gateway router）或者内部路由
器（internal router）。网关路由器是一台位于AS边缘的路由器，它直接连接到在其他AS中的一台或多台路由器。内部路由仅连接在它自己AS中的主机和路由器。

在BGP中，每对路由器通过使用179端口的半永久TCP连接交换路由选择信息。每条直接连接以及所有通过该链接发送的BGP报文，称为BGP连接（BGP connection），此外，跨越两个AS的BGP连接称为外部BGP（eBGP）连接，而在相同AS中的两台路由器之间的BGP会话称为内部BGP（iBGP）连接。
<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/498a0b207c31d94f1bf41572749e38e6.png" style="zoom: 50%;" />

NEXY-HOP为下一跳

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/f686161dc4ed17bdf49a4ddbf9b7c128.png" style="zoom:50%;" />

#### 5..4.3 确认最好的路由
当路由器通过BGP连接通告前缀时，它在前缀中包括一些BGP属性（BGP attribute）。用BGP
术语来说，前缀及其属性都称之为路由（route）。两个较为重要的属性是AS-PATH和NEXT-HOP。AS-PATH属性包含了通告已经通过的AS的列表。为了生成AS-PATH的值，当一个前缀通过某AS时，该AS将其AS号（ASN）加入AS-PATH中的现有列表。BGP路由还使用AS-PATH属性来检测和防止通告环路；特别是，如果在一台路由器在路径列表中看到了包含了它自己的AS。他将拒绝该通告。

在AS间和AS内部路由选择协议之间提供关键链路方面，NEXT-PATH属性具有敏感而重要的作用（NEXT-PATH属性在AS间和AS内部路由间提供关键链路）。NEXT-HOP是AS-PATH起始的路由器接口的IP地址。

在上图中，我们可以得到
<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/1728463005835.png" style="zoom:67%;" />

这里的前缀是哪个IPde聚合

1.热土豆路由选择
热土都路由选择（hot potato routing）
<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/1728463307217.png" style="zoom:50%;" />
这个协议也是贪心算法吧。对于路由器，它尽可能快地将分组送出自己的AS，而不担心其AS外部到目的地的余下部分的开销。热土豆路由选择是一个自私的算法，即它试图减小在它自己AS中的开销，而忽略其AS之外的端到端开销的其他部分。注意到使用热土豆路由选择，对于在相同AS中的两台路由器，可能对于相同的前缀选择选择两条不同的AS路径。

2.路由器选择算法
如果仅有一条路由，BGP显然选择该路由。如果到相同的前缀有两条或者多条路由，则顺序地调用下列消除桂萼知道余下一条一条路由:
(这里偷懒，看图)
<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/1728463853672.png" style="zoom: 80%;" />
我们可以看出BGP并不是一种自私的算法，它先查找具有短AS路径的路由。
#### 5.4.4 IP任播
BGP还可以作为实现IP任播服务（anycast），这个服务通常使用在DNS服务中。
这样有什么用处呢？
1）在许多不分散的不同地理位置，替换不同服务器上的相同内容
2）让每个用户从最靠近的服务器访问其他内容

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/1728464686920.png" style="zoom: 33%;" />

上图中,在IP任播配置阶段，CDN公司为它的多台服务器指派**相同的IP地址**，并且使用标准的BGP从这些服务器的每台来通告该IP地址。当某台BGP路由器收到对于该IP地址的多个路由通告，他将这些通告处理为相同的物理位置上配置不同的路径。当配置其路由选择时，每台路由器将本地化地使用BGP路由选择算法来挑选到该IP地址的“最好的”路由。尽管上述CDN的例子很好地诠释了能够如何使用IP任播，但实践中CDN往往不使用IP任播，**因为BGP路由选择变化能够导致相同的TCP连接的不同分组到达Web服务器的不同事例。**（不是太懂）但是IP任播被DNS请求指向最近的根DNS服务器。

#### 5.4.5 路由选择策略
在这里考虑的主要是一些现实条件吧。
比如不同的供应商之类的。自己去看书
了解一些概念：
多宿主接入ISP，经由两个不同的提供商连到网络的其余部分。
#### 5.4.6 拼装在一起：在因特网中呈现
告诉你如何注册一个Web站点
可以看一下，有助于对于前面所学的总结

### 5.5 SDN控制平面
在这里我们将网络中的转发设备称为“分组叫环节”，因为能够根据网络层源/目的地址、链路层源/目的地址以及运输层、网络层和链路层中分组首部字段做出转发决定（这里也就是通用转发）
SDN（Software-Defined Network）
SDN体系结构具有4个关键特征：
1）基于流的转发
2）数据平面和控制平面分离
3）网络控制功能：位于数据平面交换机外部

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/b91763cf0d5774daef4305cb47d252f3.png" style="zoom: 50%;" />

控制平面由两个组件组成：一个SDN控制器（或网络操作系统），以及若干网络控制应用程序。控制器维护准确的网络状态信息；为运行在控制平面中的网络控制应用程序提供这些信息；提供方法，这些应用程序通过这些方法能够监视、编程和控制下面的网络设备。
4）可编程的网络。
通过运行在控制平面中的网络控制应用程序，该网络是可编程的。这些应用程序代表了SDN控制平面的“智力”，使用了由SDN控制器提供的API来定义和控制网络设备中的数据平面。

#### 5.5.1 SDN控制平面：SDN控制器和SDN网络控制应用程序
1）通信层：SDN控制器和受控网络设备之间的通信。通过“南向”接口。
2）网络范围状态管理层：由SDN控制平面所做出的最终控制决定，将要求控制器具有有关网络的主机、链路、交换机和其他SDN控制设备的最新状态信息。
3）对于网络控制应用程序层的接口：控制器通过“北向”接口与网络控制应用交互。该API允许网络控制应用程序在状态管理层之间读/写网络状态和流表。
#### 5.5.2 OpenFlow协议
OpenFlow协议运行在SDN控制器和SDN控制之间的交换机或其他实现OpenFlow  API的设备之间。OpenFlow协议运行在TCP之上，使用6653的默认端口号。从控制器到受控交换机流动的重要报文由下面这些：
1）配置 2）修改状态 3）读状态 4）发送分组 
从受控交换机到控制器流动的重要报文有这些：
1)流删除 2）端口状态 3）分组入
#### 5.5.3 数据平面和控制平面交互的例子
见书
#### 5.5.4 SDN的过去和未来
网络功能虚拟化（NFV）的通用SDN的目标时用简单的商用服务器、交换机和存储器来颠覆性地替代复杂的中间盒。
### 5.6 ICMP：因特网控制报文协议
因特网控制报文协议（Internet Control Message Protocol，ICMP），被主机和路由器用来彼此沟通网络层的信息。

ICMP报文是作为IP有效载荷承载的。ICMP报文拥有一个类型字段和编码字段，并且包含引起该ICMP报文首次生成的IP数据报的首部和前8个字节（以便发送方能确定引发该差错的数据报）

下图展示了一些ICMP报文类型

| ICMP类型 | 编码 | 描述                     |
| -------- | ---- | ------------------------ |
| 0        | 0    | 回显回答（对ping的回答） |
| 3        | 0    | 目的网络不可达           |
| 3        | 1    | 目的网络不可达           |
| 3        | 2    | 目的协议不可达           |
| 3        | 3    | 目的端口不可达           |
| 3        | 6    | 目的网络未知             |
| 3        | 7    | 目的主机未知             |
| 4        | 0    | 源抑制（拥塞控制）       |
| 8        | 0    | 回显请求                 |
| 9        | 0    | 路由器通告               |
| 10       | 0    | 路由器发现               |
| 11       | 0    | TTL过期                  |
| 12       | 0    | IP首部损坏               |

ping程序发送一个ICMP类型8编码0的报文到指定主机。看到回显（echo）请求，目的主机发回一个类型0编码0的ICMP回显回答。

接下来，我们来认识一下Traceroute程序，该程序允许我们跟踪一台主机到世界上任意一台主机之间的路由。**Traceroute是用ICMP报文来实现的。为了判断源和目的地之间所有路由器的名字和地址，源主机中的Traceroute向目的地主机发送一系列普通的IP数据报。这些数据报的每个携带了一个具有不可达UDP端口的UDP报文段。第一个数据报的TTL为1，第二个的TTL为2，依次类推。该源主机也为每个数据报启动定时器，当第n个数据报到达第n台路由器时，第n台路由器观察到这个数据报的TTL刚好过期。根据IP协议规则，路由器丢失该数据报并发送一个ICMP告警报文给源主机（类型11编码0）。该告警报文包含了路由器的名字和它的IP地址。当该ICMP报文返回源主机时，源主机从定时器得到往返时延，从ICMP报文中得到第n台路由器的名字和IP地址。**

因为该数据报包含了一个不可达端口号的UDP报文段，该目的主机向源发送一个端口不可达的ICMP报文（类型3编码3）。当源主机收到这个特别的ICMP报文时，知道可以停止发送ICMP报文，不需要再发送另外的探测分组。（实际上，Traceroute程序对于每个相同TTL的ICMP报文发送了三个，因此他也会收到三个结果）

ICMPv6中还增加了新的IPv6功能所需的新类型和编码。这些包括“分组太大”类型和一个“未被承认的IPv6选项”差错编码。
### 5.7 网络管理和SNMP
网络管理：网络管理包括了硬件、软件和人类元素的设置、综合和协调，以监视、测试、轮询、配置、分析、评价和控制网络及网元资源，用合理的成本满足实时性、运行性能和服务质量的要求。（典型官话，烦人）
#### 5.7.1 网络管理框架
<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/01f1e089f49fb82141c6eefa34a4b4c6.png" style="zoom:50%;" />

**管理服务器（managing server）**：是一个应用程序，通常有人的参与，并运行再网络运营中心（NOC）的集中式网络工作站上。管理服务器是执行网络管理活动的地方，它控制网络管理信息的收集、处理、分析和/或显示。
**被管设备（managed device）**：是网络设备的一部分（包括他的软件），位于被管理的网络中。被管设备可以是一台主机、路由器、交换机、中间盒、调制解调温度计或者其他联网的设备。在一个被管设备中，有几个所谓被管对象（managed object）。这些被管对象是被管设备中硬件的实际部分和用于这些硬件及软件组成的配置参数。
一个被管设备中的每个被管对象的关联信息收集在管理信息库（Management Information Base，MIB）中，这些信息的值可以被管理服务器使用。MIB对象由称为SMI（Structure of Management Information）的数据描述语言所定义。
在每个被管设备中还由网络管理管理（network management agent），它是运行在被管设备中的一个进程，该进程与管理服务器通信，在管理服务器的命令和控制下在被管设备中采取本地动作。
**网络管理协议（network management protocol）**：运行在管理服务器和被管设备之间，允许管理服务器查询被管设备的状态，并经过其代理间接地在这些设备上采取行动，代理可以使用网络管理协议向管理服务器用纸异常事件。网络管理协议自身并不能管理网络。
#### 5.7.2 简单网络管理协议
简单网络管理协议（Simple Network Management Protocol，SNMP）是一个应用层协议，用于在管理服务器和代理管理服务器执行的代理之间传递网络管理控制和信息报文。SNMP最常使用的是请求响应模式，其中SNMP管理服务器向SNMP发送一个请求，代理收到请求后，执行某些动作，然后对该请求有一个回答。SNMP第二个常被使用的代理向管理服务器发送的一个非请求报文，该报文称为陷阱报文（trap message）。陷阱报文用于通知管理服务器，一个异常情况的出现导致了MIB对象值的变化。

下面展示了一些报文类型，这些报文一般称为协议数据单元（Protocol Data Unit，PDU）

| SNMPv2  PDU类型 | 发送方-接收方                | 描述                                |
| --------------- | ---------------------------- | ----------------------------------- |
| GetRequest      | 管理者到代理                 | 取得一个或者多个MIB对象实例值       |
| GetNextRequest  | 管理者到代理                 | 去的列表或表格中下一个MIB对象实例值 |
| GetBulkRequest  | 管理者到代理                 | 以大数据块方式取得值                |
| InformRequest   | 管理者到管理者               | 向不能访问的远程管理实体通知MIB值   |
| SetRequest      | 管理者到代理                 | 设置一个或者多个MIB对象实例的值     |
| Response        | 管理者到代理或管理者到管理者 | 对上面5种的回应                     |
| SNMPv2 Trap     | 代理到管理者                 | 向管理者通知一个异常事件            |

这个Trap报文不辍所料地话，就是最重要的那个地方。

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/0b595fbafab2f840222810157e8d3a03.png" style="zoom: 75%;" />

上图为SNMP PDU的格式

对于GetRequest、GetNextRequest、GetBulkRequest，我们自不用多说，这些从名字我们基本就可以看出其作用。
管理服务器使用SetRequest PDU来设置位于被管设备中的一个或多个MIB对象的值。代理用带有”noError“戳错状态的Response PDU进行应答，以证实该值的确已被设置。
管理服务器使用InformRequest PDU来通知另外一个MIB信息管理服务器，后者对于接收服务器是远程的。
Trap PDU，是异步产生的，即他们不是为了响应接收到的请求而产生的，而是为了响应管理服务器要求统治的事件而产生的。

SNMP PDU通常作为UDP数据报（为什么不是报文段）的载荷来进行传输的。管理服务器用该PDU的请求ID字段作为它向代理发送的请求编号；该代理的响应从接收到的请求中获取它的请求ID，因为词，该请求ID字段可以用来被管理服务器用来检测丢失的请求或者回答。**如果在一定时间后，还没有收到对应的响应，由管理服务器来决定他是否重传以一个请求。**SNMP标准没有强制任何特殊的重传过程。
SNMPv3更加安全

## 第6章 链路层和局域网
在这里会出现两种链路：1）广播链路，这种信道用于连接有限局域网、卫星网和混合光纤同轴电缆（Hybrid Fiber Coaxial cable，HFC）接入网中的多台主机。因为许多主机与相同的广播信道连接，需要所谓的媒体访问协议来协调帧传输 2）点到点通信链路，这在注入长距离链路连接的两台路由器之间，或用户办公室计算机与它们所连接的邻近以太网交换机之间被使用。

### 6.1 链路层描述
运行链路层协议的任何设备称为节点（node）。把沿着通信路径连接相邻结点的通信信道成为链路（link）。
下面这段文字形象介绍了链路层和网络层之间的关系。
**为了透彻理解链路层以及它是如何与网络层关联的,我们考虑一个交通运输的类比例
子。假如一个旅行社计划为游客开辟从美国新泽西州的普林斯顿到瑞士洛桑的旅游路线。
假定该旅行社认为对于游客而言最为便利的方案是:从普林斯顿乘豪华大轿车到JFK机
场,然后乘飞机从JFK机场去日内瓦机场,最后乘火车从日内瓦机场到洛桑火车站。一旦
该旅行社作了这3项预定,普林斯顿豪华大轿车公司将负责将游客从普林斯顿带到JFK,
航空公司将负责将游客从JFK带到日内瓦,瑞士火车服务将负责将游客从日内瓦带到洛
桑。该旅程中3段中的每一段都在两个“相邻”地点之间是“直达的”。注意到这3段运
输是由不同的公司管理,使用了完全不同的运输方式(豪华大轿车、飞机和火车)。尽管
运输方式不同,但它们都提供了将旅客从一个地点运输到相邻地点的基本服务。在这个运
输类比中,一个游客好比一个数据报,每个运输区段好比一条链路,每种运输方式好比一
种链路层协议,而该旅行社好比一个路由选择协议。**

#### 6.1.1 链路层提供的服务
1）成帧。将网路层数据报封装成链路层帧  2）链路接入。媒体访问控制（Medium Access Control，MAC）协议规定了帧在链路上如何传输的规则。 3）可靠传输。 4）差错检测和纠正。

#### 6.1.2 链路层在何处实现
链路层实现在路由器的线路卡中。

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/1caa040278a215c658992da3abb6ef48.png" style="zoom:50%;" />



链路层的主体部分是在网络适配器（networjk adapter）中实现的，网络适配器也被称为网络接口卡（Network  Interface Card,NIC)，也就是网卡啦。位于网络适配器核心的是链路层控制器，该控制器通常是一个实现了许多链路层服务的专用芯片，链路层控制器的许多功能是用硬件来实现的。

在图中，我们还可以看出，尽管大部分的链路层实在硬件中实现的，但部分链路层实在运行于主机CPU上的软件中实现的。链路层的软件组件实现了高层链路功能。链路层是硬件与软件的结合体，此处是协议栈中软件和硬件交接的地方。

### 6.2 差错检测和纠正技术
<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/a775c2d657266a9e1397620aa86414ee.png" style="zoom:50%;" />

我们在发送节点，为了保护比特免受差错，适用差错检测和纠正比特（Error-Detcetion and-Correction，EDC）来增强数据D。但是此时传输数据的有效数据占比会少。一般来说，差错检测和纠错技术越复杂（就是使得未检测出比特差错概率较小的技术），导致的开销就越大，，这就意味着需要引入更多的计算量以及更多的差错检测和纠错比特。

发现差错检测方案有时并不能检测到差错，比如奇偶检验出现两位差错时，这时就无法检测到差错，我们希望采取这种不幸的事件发生概率很小的差错检测方案。

#### 6.2.1 奇偶检验
最简单的方法就是使用单个奇偶校验位（parity bit）。在偶检验方案中，发送方在原有帧的基础上，添加一个附加的比特，选择它的值，使得这d+1位比特（初始信息加上一个检验比特）中1的总数为偶数。同理对于奇校验方案，就是使得1的总数为奇数。采用异或的方法得出校验位的数值。

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/351a7a2d1569bf385734437d4a304d8a.png" style="zoom:75%;" />

使用这种二维奇偶校验（two-dimensional parity)，可以检测到单个比特出现错误，还可以进行纠正。

接收方检测和纠正差错的能力被称为**前向纠错（Forward Error Correction，FEC）**

#### 6.2.2 检验和方法
这个和前面运输层哪里是一样的，但是也存在新的讨论。
检验和方法需要的相对小的分组开销。然后与循环冗余检测（CRC）相比，它们提供相对弱的差错保护。
那么为什么运输层使用检验和而链路层使用CRC呢？
运输层通常是在主机中作为用户操作系统的一部分来实现的。因为运输层差错检测用软件实现，采用简单而快速如检验和这样的差错检测方案是重要的。在另一方面，链路层的差错检测在适配器中用专用的硬件实现，它可以快速执行更复杂的CRC操作。
#### 6.2.3循环冗余检测
循环冗余检测（Cyclic Redundancy Check，CRC）。CRC编码也称为多项式编码（polynomial code）
$$
D·2^r XOR \,R = nG
$$
我们进而可以得到
$$
R = remainder \frac{D·2^r}{G}
$$
在这里应该就懂了吧，我们在已知D，r，G的情况下可以计算得到一个R，把它作为CRC比特
这里D就是要传输的数据，r为CRC比特的位数，G为生成多项式（generator）

每个CRC标准都可以检测小于r+1比特的突发差错。

### 6.3 多路访问链路和协议
点到点链路（point-to-point link）由链路一端的单个发送方和链路另一端的单个接收方组成。这样的协议有点对点协议（point-to-point protocol，PPP）和高级数据链路控制（high-level data link control，HDLC）
广播链路（broadcast link）可以让多个发送方和接收节点都连接到相同的、单一的、共享的广播信道上。这里广播是指，当任何一个节点传输一个帧时，信道广播该帧，每个其他节点都可以收到一个副本。
本章所讲述的是如何协多个发送和接收节点对一个共享广播信道的访问，这就是多路访问问题（multiple access problem）
下面这段话可以形象的描述这段协议：
**“给每个人一个讲话的机会”
“该你讲话时你才说话”
“不要一个人独占整个说话”
“如果有问题请举手”
“当有人讲话时不要打断”
“当其他人讲话时不要打断”**
计算机网络有着类似的规则，称之为多路访问协议（multiple access protocol）

所有节点都能够传输帧，多个节点可能会同时传输帧。当发生这种情况时，所有节点同时接到多个帧；传输的帧在所有的接收方处碰撞（collide）。当碰撞发生时，没有一个接收节点能够有效地获取任何传输的帧。

我们可以将任何多路访问协议划分为3种类型之一：信道划分协议（channel partitioning protocol）、随机接入协议（random access protocol)和轮流协议（taking-turns protocol).
我们希望协议具有这样的特性：
1）当仅有一个节点发送数据时，该节点具有Rbps的吞吐量；
2）当有M个节点发送数据时，每个节点吞吐量为R/Mbps。这不是要求M个节点种的每一个节点总是有R/M的瞬时速率，而是每个节点在一些适当定义时间间隔内应该有R/M的平均传输速率。
3）协议是分散的；这就是说不会因某主节点故障而使整个系统崩溃。
4）协议是简单的，使实现不昂贵

#### 6.3.1 信道划分协议
这里其实不用太多过于事件介绍，关于整个信道划分在好多地方都见过了
TDM 时分多路复用
FDM 频分多路复用
这两个是简单的

码分多址（Code Division Multiple Access，CDMA）。TDM和FDM分别为节点分配时隙和频率，而CDMA为每个节点分配一种不同的编码，然后每个节点用它唯一的编码来对他发送的数据进行编码。如果精心选择这些编码，CDMA网络仍然具有一种奇妙的特性，即不同的节点能够同时传输，并且他们各自相应的接收方仍能正确接收发送方编码的数据比特。

#### 6.3.2 随机接入协议
在随机接入协议中，一个传输节点总是以信道的全部速率（即Rbps）进行发送。当有碰撞时，涉及碰撞的每个节点反复地重发它的帧，到该帧无碰撞地通过为止。但是当一个节点经历一次碰撞时，它不必立刻重发该帧，它在重发该帧之前等待一个随机时延。涉及碰撞的每个节点可以独立地选择随机时延。
ALOHA协议和载波侦听多路访问（CSMA）协议
1.协议ALOHA

我们在对时隙ALOHA的买哦书中，我们做下列假设：

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/cf7d25d170bc3e524395c1332b207528.png" style="zoom:50%;" />



与信道划分不同，当某节点是唯一的节点时（一个节点如果有帧要发送就认为他是活跃的），时隙ALOHA允许该节点以全速R连续传输。时隙ALOHA也是高度分散的，因为每个节点检测碰撞并独立地决定什么时候重传。



<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/6a8b039146be472fa1fea419527ed114.png" style="zoom: 67%;" />

1)当有多个活跃节点时，一部分时隙将会有碰撞，因此将被”浪费“掉了
2)时隙的另一部分将是空闲的，因为所有活跃节点由于概率传输策略会节制传输。

唯一”未浪费的"时隙时那些刚好有一个节点传输的时候，刚好有一个节点传输的时隙称为一个成功时隙（successful slot）。时隙访问协议的效率（efficiency）定义为：当有大量的活跃节点并且每一个节点总有大量的帧要发送时，长期运行中成功时隙的份额。

当有N个活跃节点，每个节点对新帧和已经经历过一次碰撞的帧都以概率p传输，时隙ALOHA的概率是
$$
Np(1-p)^{N-1}
$$
经过讨论之后我们可以知道，协议的最大效率为37%，当有大量节点有很多帧要传输时，则最多仅有37%得时隙做有用的工作。因此该时隙有效传输速率为0.37Rbps。同样有分析表明37%的时隙是空闲的，26%的时隙有碰撞。

2.ALOHA
我们知道在时隙ALOHA协议中，**要求所有的节点同步他们的传输，以在每个时隙开始时开始传输。**
但是呢，第一个ALOHA协议并非如此，他是一个非时隙、完全分散的协议。在纯ALOHA中，当一帧首次到达（即以恶搞网络层数据报在发送节点从网络层传递下来），节点立刻将该帧完整地传输进广播信道。如果一个传输的帧与一个或者多个传输经历了碰撞，这个节点将立即（在完全传输完它的碰撞帧之后）以概率p重传该帧。否则，该节点等待一个帧传输时间。在此之后，它则以概率p传输该帧，或者以概率1-p在另一个帧时间等待。

纯ALOHA协议的最大效率时1/（2e）

3.载波侦听多路访问（CSMA）
1）说话之前先听，载波侦听（carrier sensing），即**一个节点在传输前先听信道。**如果来自另一个节点的帧正向信道上发送，节点则等待直到检测到一小段时间没有传输，然后开始传输。
2）如果要和他人同时开始说话，碰撞检测（collision detection），即**当一个传输节点在传输时一直在侦听此信道**。如果它检测到另一个节点正在传输干扰帧，他就停止传输，在重复“侦听-当空闲时传输”循环一直到之前等待一段随机时间。

这里i两个规则都包括再载波侦听多路访问（Carrier Sense Multiple Access，CSMA）和具有碰撞检测的CSMA（CSMA with Collision Detection，CSMA/CD）协议簇中。

可能有人会想一个问题，为什么所有的节点都进行载波侦听了，为什么还是会发生碰撞呢？
这可能是由于信道传播时延（channel propagation delay）（信号从一个系欸但传播到另一个节点所花费的时间），在起作用。该传播时延越长，载波侦听节点不饿能侦听到网络中另一个节点开始传输的结汇就越大

4.具有碰撞检测的载波侦听多路访问（CSMA/CD）
我们进行分析，对CSMA/CD，我们从与广播信道相连的适配器（在节点中）的角度总结它的运行：
1）适配器从网络层一条获得数据报，准备链路层帧，并将其放入帧匹配器缓存中。（**这里网络层一条，这个称呼比较奇葩**）
2）如果适配器检测到信道空闲（即无信号能量从信道进入适配器），它开始传输帧。在另一方面，如果适配器侦听到信道正在忙，它将等待，直到侦听到没有信号能量时才开始传输帧。
3）在传输过程中，适配器监视来自其他使用的适配器的信号能的存在。
4）如果适配器传输整个帧而未检测到来自其他适配器的信号能，该适配器就完成了该帧。在另一方面，如果适配器在传输时检测到来自其他适配器的信号能量，**他中止了传输（即它停止了传输帧）**
5）中止传输后，适配器等待一个随机时间量，然后范围步骤2.

关于这个等待时间如何确认？
采用二进制指数后退（binary exponential backoff）算法，当传输一个给定帧时，在该帧经历了一连串的n次碰撞后，节点随机地从{0，1，2，···，2^n^-1}中选择一个K值。对于因特网，一个节点等待的实际时间量是K·512比特时间（即发送512比特进入以太网所需时间量的K倍），n可以取的最大值在10以内。

5.CSMA/CD效率
我们将CSMA/CD效率定义为：当有大量的活跃节点，且每个节点有大量的帧要发送时，帧在信道中无碰撞地传输的那部分时间在长期运行时间中所占的份额。
令d<sub>prop</sub>表示信号能量在任意两个适配器之间传播所需的最大时间。令d<sub>trans</sub>表示一个最大长度的以太网帧的时间。下面是一个近似式
$$
效率=\frac{1}{1+5d_{prop}/d_{trans}}
$$
prop指的是传播时延，trans指的是传输时延，你应该还记得这些是什么吧
传播时延是指在信道上传播，传输时延是指发送的链路上

#### 6.3.3 轮流协议
我们在前面讲过多路访问协议的两个理想特性是
1）当只有一个节点活跃时，该活跃节点具有Rbps的吞吐量；
2）当有M个节点活跃时，每个活跃节点的吞吐量接近R/Mbps。
ALOHA和CSMA协议具备第一个特性，但不具备第二个特性。
轮流协议（taking-turns protocol）应运而生

在这里我们主要讨论两种轮流协议：
1）轮询协议（polling  protocol）
在这里，众多节点之一被指定为主节点，主节点一循环的方式轮询（poll）每个节点。主节点会向每个节点轮流循环发送一个报文，告知其可以传输帧的最多数量。主节点以这种方式循环轮询了每个节点。
这样的缺点是：1.协议引入了轮询时延   2.当主节点出现问题时，系统将陷入瘫痪
2）令牌传递协议（token-passing protocol）
一个称为令牌（token）的小的特殊帧在节点之间以某种固定的次序进行交换。当一个节点收到令牌时，如果它的确有帧要传输，他发送最大数目的帧数，然后向下一个节点传递令牌。
缺点是：一个节点的故障可能会导致整个信道出现崩溃。或者一个节点偶然忘记了释放令牌，则必须调用某些回复步骤使令牌返回到循环中来。

#### 6.3.4 DOCSIS：用于电缆因特网接入的链路层协议
<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/b7db69332a18812e121e2be7bd0696b1.png" style="zoom:50%;" />

电缆调制解调器端系统（Cable Modem Termination System，CMTS），数据经电缆服务接口（Data-Over-Cable Service Interface ，CMTS）规范（DOCISIS）定义了电缆数据网络体系结构及其协议。

如图，每条上行信道被划分为时间间隔（类似于TDM），每个时间间隔内包含有一个微时隙序列。电缆调制解调器可在该该微时隙中向CMTS传输。CMTS在下行信道中通过发送称为MAP报文的控制报文，指定那个电缆调制解调器（若有要发送的数据）能够在微时隙虹传输由控制报文指定的时间间隙，由于微时隙明确分配给电缆调制解调器，故CMTS能够确保在微时隙中没有碰撞传输。

CMTS是如何得知那个电缆调制解调器有数据要发送呢？
通过让电缆调制解调器在专用于地目的的一组特殊的微时隙间隔内向CMTS发送微时隙请求帧来完成该任务。这些微时隙请求帧以随机接入方式传输，故该可能相互碰撞，电缆调制解调器既不能侦听上行信道是否忙，也不了检测碰撞。相反，该电缆调制解调器如果没有在下一个下行控制报文中收到对请求分配的响应的话，就推断出它的微时隙请求帧经历了一次碰撞，电缆调制解调器使用二进制指数回退将其微时隙请求帧延缓到以后的时隙重新发送。当在上行信道上有很少的流量，电缆调制解调器可能在名义上分配给微时隙请求帧的时隙内实际传输数据（因此避免不得不等待微时隙分配）

### 6.4 交换局域网
#### 6.4.1 链路层寻址和ARP
1.MAC地址
这里和IP的那个地方一样
**事实上，并不是主机或路由器具有链路层地址，而是他们的适配器（即网络接口）具有链路层地址，具有多个网络接口的主机或路由器将具有与之相关联的多个链路层地址**

**我们注意到链路层交换机并不具有与它们的接口相关联的链路层地址。这是因为链路层交换机的
任务是在主机与路由器之间承载数据；交换机透明地执行该任务，这就是说，主机或路由器不必明确地将帧寻址到期间的交换**

链路层有不同的称呼：LAN地址（LAN address）、物理地址（physical address）或者MAC 地址

**一般来说一台设备的MAC地址是永久不变的**

MAC地址为6字节，48位
一块适配器（即网络接口）可以接受一个并非向他寻址的帧，这样，当适配器接收到一个帧时，将会检查该帧中的目的MAC地址是否与它自己的MAC地址匹配。如果陪陪，该适配器提取出封装的数据报，并将该数据报沿协议向上传递。如果不匹配，该适配器丢弃该帧，而不会向上传输该网络层数据报，所以，仅当收到该帧时，才会阻断目的地。

MAC广播地址FF-FF-FF-FF。

2地址解析协议
地址解析协议（Address Resolution Protocol，ARP），将一个IP地址解析为MAC地址。ARP只为在用一个子网中的主机和路由器接口解析IP地址。

每台路由器或主机在内存中具有一个ARP表（ARP table），包含IP地址-MAC地址-TTL
TTL指示了从表中删除每个映射的时间。

发送方构造一个称为ARP分组（ARP packet）的特殊分组。一个ARP分组有几个字段，包括发送和接收IP地址及MAC地址。ARP查询分组和响应分组都具有相同的格式。ARP查询分组的目的时询问子网所有其他主机和路由器，以确定对应于要解析的IP地址的那个MAC地址。

包含该ARP查询的帧能被子网上的所有其他适配器都接收到，并且每个适配器都把该帧中的ARP分组向上传递给ARP模块，这些ARP模块中的每个都查询它的IP地址是否与ARP分组中的目的IP地址相匹配。与之匹配的一个给查询主机发送回一个带有所希望映射的响应ARP分组。然后查询主机就可以更新自己的ARP表。

查询帧实在广播帧中发送，响应ARP报文在一个标准帧中发送。

把ARP视作跨越链路层和网络层边界的协议

3.发送数据报到子网以外
目的IP就是那个最终的IP，目的MAC为下一跳的MAC地址。

#### 6.4.2 以太网
集线器（hub）是一种物理设备，他作用域比特，那也就是说它属于物理层设备啦。

1.以太网帧结构

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/476c8820012fca5bcc60ecce5d9d826f.png" style="zoom:50%;" />

1)数据字段（46字节~1500字节）。这个字段承载了IP数据报。以太网的最大传输单元（Maximum Transmission Unit，MTU）是1500字节。这意味着IP数据报如果超过了1500字节，则主机必须将该数据报分片。数据字段的最小长度为46字节。这意味着如果IP数据报小于46字节，数据报必须被填充到46字节。当采用填充时，传递到网络层的数据包括IP数据报和填充部分。网络层使用IP数据报首部中的长度字段来去除填部分。
2)目的地址（6字节）这个字段包含目的适配器的MAC地址。
3)源地址（6字节）
4)类型字段（2字节）：类型字段允许以太网复用多种网路层协议。网络层协议不止IP一种
5)CRC（4字节）：循环冗余检测
6)前同步码（8字节）：以太网帧以一个8字节的前同步码（Preamble）字段开始。该前同步码的前七个字节的值都是10101010；最后一个字节时01011011.前同步码字段的前7个字节用于”唤醒“接收适配器，并且将它们的时钟和发送方的时钟同步。

以太网技术向网络层提供不可靠服务。特别是，当适配器B收到一个来自适配器A的帧，他对该帧执行CRC校验。但是当该帧通过CRC校验时，它既不发送确认帧（ACK）；而当帧没有通过时，他也不发送否定确认帧（NACK）。当某帧没有通过CRC校验，适配器B只是丢弃该帧。适配器A根本不知道它传输的帧是否到达了B并通过了CRC校验。这意味着，传递到网络层的数据流能够有间隙。

主机B上的应用会看见这个间隙吗？
如果应用使用的是UDP，则主机B中的应用的确会看到数据中的间隙。另一方面，如果应用使用的是TCP，则主机B中的TCP将不会确认包含在丢弃帧中的数据，从而引起主机A的TCP重传。注意到当TCP重传数据时，数据最终回到曾经丢弃它的以太网适配器。因此，可以说，尽管以太网重传了数据，但是以太网不知道他是正在传输一个具有全新数据的全新数据报，还是一个包含已经被传输过至少一次的数据的数据报。（**没看懂这里**）

2.以太网技术
通过使用转发器（repeater）能够得到更长的运行距离，转发器是一种物理层设备，它可以在输入端接收信号并在输出端再生该信号。
#### 6.4.3 链路层交换机
交换机自身对于子网中的主机和路由器都是透明的（transparent);这就是说，某主机/路由器向另一个主机/路由器寻址一个帧（而不是像交换机寻址该帧），顺利地将该帧发送进局域网，并不知道某交换机将会接收该帧并将他它转发到另一个节点。这些帧到达该交换机的任何输出接口之一的速率可能暂时会超过该接口的链路容量。交换机输出接口设有缓存。

1.交换机转发和过滤
**过滤（filtering）**是决定一个帧应该转发到某个接口还是应当将其丢弃的交换机功能。
**转发（fowarding）**是决定一个帧应该被导向那个接口，并把该帧移动到那些接口的交换机功能。
交换机的过滤和转发都借助于交换机表（switch table）完成。交换机表中包括：
1）一个MAC地址
2）通向该MAC地址的交换机接口
3）表项放置在白哦中的时间（是指表项起始放在表中的时间）

假定目的地址为DD--DD-DD-DD-DD-DD的帧从交换机接口x到达。交换机用MAC地址DD-DD-DD-DD-DD-DD索引它的表。有三种可能的情况：
**1）表中没有对于DD-DD-DD-DD-DD-DD的表项。在这种情况下，交换机向除接口x外的所有接口前面的输出缓存转发该帧的副本。也就是，如果没有对于目的地址的表现，交换机广播该帧。**
2）表中有一个表项将DD-DD-DD-DD-DD-DD与接口x联系起来。在这种情况下，该帧从包括适配器DD-DD-DD-DD-DD-DD的局域网网段到来。无须将该帧转发到任何接口，叫环节通过丢弃该帧执行过滤功能即可。
3）表中有一个表项将DD-DD-DD-DD-DD-DD与接口$$y\neq x$$联系起来，在这种情况下，该帧需要被转发到与接口y相连的局域网网段。交换机通过将该帧放在接口y前面的输出缓存完成转发功能。

2.自学习
自学习（self-learning）

1）交换机表初始为空
2）对于在每个接口收到的每个入帧，该交换机在其表中存储：$$\enclose{circle}{1} \\$$在该帧源地址字段中的MAC地址 ;$$\enclose{circle}{2}$$该帧到达的接口；$$\enclose{circle}{3}$$当前时间。交换机以这种方式在它的表中记录了发送节点所在的局域网网段。
3）如果在一段事件后（称为老化期（aging time））后，交换机没有接收到以该地址作为源地址的帧，就在表中删除这个地址。以这种方式，如果一台PC被另一台PC代替，原来PC的MAC地址将最终从该交换机表种被清除掉。

交换机是即插即用设备（plug-and-play device）。它们不需要网络管理员或用户的干预。要安装交换机的网络管理员除了将局域网段与交换机的接口相连外，不需要做其他任何事情。交换机也是双工的，这意味着任何交换机接口可以同时发送和接收。

3.链路层交换机的性质
1）消除碰撞   2）异质的链路。交换机将了链路彼此隔离，因此局域网中的不同链路能够以不同的速度运行并且在不同的媒体上运行。 3）管理。

**一个众所周知的对抗交换机的攻击称为交换机毒化（switch poisoning），它向交换机发送大量的具有不同伪造源MAC地址的分组，因而用伪造表项填满了交换机表，没有为合法主机留下空间。但是呢，这种攻击只有很强的攻击者才可以做到，因此交换机比起集线器和无线局域网来更难收到嗅探**

4.交换机和路由器比较
交换机是链路层的分组交换机，而路由器是网络层的分组交换机。

我们接下来来考虑交换机的优点和缺点。交换机是即插即用的，交换机还具有相对高的分组过滤和转发速率，交换机必须处理第二层的帧，路由器必须处理第三层的数据报。为了防止广播帧的循环，交换网络的活跃拓扑限制生成了客观的ARP流量和处理量。而且，交换机对于广播风暴并不提供任何保护措施，即如果某主机出了故障并传输出没完没了的以太网广播帧流，该交换机将转发所有这些帧，使得整个以太网的崩溃。

路由器的优点和缺点。因为网络寻址通常是分层次的，（不像MAC寻址那样是扁平的），即使当网络中存在冗余路径时，分组通常也不通过路由器循环。所以，分组就不会被限制到一颗生成树上，并可以使用源和目的地址之间的最佳路径。因为生成树没有生成树限制，所以它们允许以丰富的拓扑结构构建因特网。路由器的另一个特色是它们对第二层的广播风暴提供了防火墙保护。尽管也许路由器最重要的缺点就是它们不是即插即用的，即路由器和连接到它们的主机都需要人为地配置IP地址。而且路由器对每个分组的处理时间通常比交换机更长。因为它们有网络层，必须处理位于网络层的字段。

下表是对一些典型设备的比较：

|          | 集线器 | 路由器 | 交换机 |
| -------- | ------ | ------ | ------ |
| 流量间隔 | 无     | 有     | 有     |
| 即插即用 | 有     | 无     | 有     |
| 优化路由 | 无     | 有     | 无     |

#### 6.4.4 虚拟局域网
虚拟局域网（Virtual Local Area Network，VLAN），在一个VLAN内的主机彼此通信。

放图，相信你还记得这个点,就是在多个交换机上的VLAN

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/79f0a3cfe706ed68a6c43d6f109d5b68.png" style="zoom:50%;" />

在图中下面的那个干线连接，我们可以看到下面使用一个链路去连接两个交换机。这个时候需要某个东西来确定转发到那个VLAN

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/d6da1fbc5a02df781e68e61b0bf6fda0.png" style="zoom:50%;" />

对比我们可以发现，相较于初始的以太网帧，802.1Q帧在首部种添加了一个4字节的vLAN标签（VLAN tag）组成，VLAN标签由在VLAN干线发送侧的交换机加进帧中，解析后并由在VLAN干线接受侧的交换机删除。VLAN标签自身由一个2字节的标签协议标识符（Tag Protocol Identifier，TPID）字段（具有固定的十六进制81-00），一个2字节的标签控制信息字段（包含一个12比特的VLAN标识符字段）和一个3比特优先权字段。（具有类似于IP数据报TOS字段也就是服务类型字段的目的）组成。

VLAN可以基于端口，基于MAC，基于网络层协议。

### 6.5 链路虚拟化：网络作为链路层
多协议标签网络（Multiprotocol Label Switching，MPLS）网络，MPLS客观上讲的是一种分组交换的虚电路网络。目的是为了改善IP路由器的转发速度。它采用来自虚电路网络领域的一个关键观念：固定长度标签。其目标是：对于基于固定长度标签和虚电路的技术，在不放弃基于目的地IP数据报转发的基础设施的前提下，当可能时通过选择性地标识数据报并允许路由器基于固定长度的标签（而不是目的地IP地址）转发数据报来增强其功能。

MPLS使能的路由器处理的链路层帧格式。

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/0c5305df66b7c43852ee858101071cb9.png" style="zoom:50%;" />

将一个小的MPLS首部添加到第二层首部和第三层首部之间。包含在MPLS首部中的字段时：标签；预留的3比特实验字段；1比特S字段，用于指示一系列”成栈“的MPLS首部的结束；寿命字段。

一个MPLS加强的帧仅能在两个均为MPLS使能的路由器之间发送。一个MPLS使能的路由器通常被称为标签交换路由器（label-switched router）

通过MPLS标签将数据报传递给适当的输出接口来转发MPLS帧。

MPLS提供了沿着多条路由转发分组的能力，使用标准IP路由选择协议这些路由将是不可能的。这是使用MPLS形式的流量工程（traffic engineering），其中网络执行者能够超越普通的IP路由选择，迫使某些流量沿着一条路径朝着某给定的目的地引导，并且朝着相同目的地的其他流量沿着另外一条路径流动。
同时MPLS能够用于执行MPLS转发路径的快速恢复。并且MPLS也可以用于实现虚拟专用网（Virtual Private Network，VPN）。在为用户实现一个VPNR的过程中，ISP使用它的MPLS使能网络将用户的各种网络连接在一起。MPLS能够被用于将资源和由用户的VPN使用的寻址方式相隔离，其他用户利用该VPN跨越该ISP网络。

### 6.6 数据中心网络
基本呢，好多有名软件都具有自身的数据中心。每个数据中心都具有自己的数据中心网络（data center network),这些数据中心网络用于将其内部主机彼此互联并与因特网中的数据中心互联。

主机负责提供内容，存储邮件和文档，并共同执行大规模分布式计算。数据中心中的主机称为刀片（blade)，一般是包括CPU、内存和磁盘存储的商用主机。主机被堆叠在机架上，每个机架一般堆放20~40台刀片。在每一个机架顶部有一台交换机，这台交换机被形象地称为机架顶部（Top of Rack，TOR）交换机。它们于机架上的主机互联，并与数据中心中的其他交换机互联。每个主机都有一个与TOR交换机连接的网卡，同时每台交换机都具有额外的端口能够与其他TOR交换机连接。

数据中心支持两种类型的网络：在外部客户与内部主机之间流动的流量，以及内部主机之间流动的流量。

为了处理外部客户与内部主机之间流动的流量，数据中心网络包括了一台或者多台边界路由器（border router），它们将数据中心网络与公共因特网相连。数据中心网络因此需要将所有的机架彼此互联，并将机架与外界路由器连接。

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/a61ff91066d5fa36f9a3bab185c99fe8.png" style="zoom:50%;" />

1.负载均衡
在数据中心内部，外部请求首先被定向到一个负载均衡器（load balancer）。负载均衡器的任务是向主机分发请求，以主机当前的负载作为函数来在主机之间均衡负载。

负载均衡器不仅平衡主机间的工作负载，而且还提供类似NAT的功能，将外部IP地址转换位内部适当主机的IP地址，然后将反方向流向客户的分组按照相反的转换继续处理。

2.等级体系结构
3.数据中心网络的发展趋势
采用全连接拓扑（fully connected topology）

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/48b1a742e338e2bc39f75d7f378468bc.png" style="zoom:50%;" />

另外一种是次啊用模块化数据中心（Modular Data Center，MDC），简单了解下吧

### 6.7 回顾：Web页面请求的历程
这个可以看一下，相当于是对前面所学的应用和回顾

## 第7章 无线网络和移动网络
### 7.1 概述
下图展示了一些较为流行的无线链路标准的两个主要特性（覆盖区域和链路速率）

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/08c6091a003872a476d3c05765144f07.png" style="zoom:50%;" />

主要需要记忆的那些应该就是左侧的那些802标准

无线网络的要素：

无线主机
无线链路
基站：基站（base statio）是无线网络基础设施的一个关键部分。与无线主机和无线链路不同，基站在有线网络中没有明确的对应设备。它负责向与之关联的无线主机发送数据和从主机哪里接收数据。基站通常负责协调与之相关联的多个无线主机的传输。当我们描述一台无线主机与某基站“相关联”时，则是指:$$\enclose{circle}{1}$$该主机位于该基站的无线通信覆盖范围内；$$\enclose{circle}{2}$$该主机使用该基站中继它和更大网络之间的数据。蜂窝网络中的蜂窝塔（cell tower）和802.11无线LAN中的接入点（access point）就是基站。
网络基础设施

与基站相关联的主机通常被称为以基础设施模式（infrastructure mode）运行，因为传统的网络服务（如地址分配和路由选择）都由网络向通过基站相连的主机提供。在自组织网络（ad hoc network)中，网络主机没有与这样的基础设施相连。在没有这样的基础设施的情况下，主机本身必须提供诸如路由选择、地址分配、类似于DNS的名字转换等服务。

在最高层次我们可以根据两个准则来对无线网络进行分类：$$\enclose{circle}{1}$$在该无线网络中的分组是否跨越了一个无线跳或者多个无线跳；$$\enclose{circle}{2}$$：网络中是否有诸如基站这样的基础设施。
1）单跳，基于基础设施。 2) 单跳，无基础设施。 3）多跳，基于基础设施。 4）多跳，无基础设施。

### 7.2 无线链路和网络特征
我们可以知道，电磁波在穿过物体时，强度将减弱。即使在自由空间中，信号仍然扩散，这使得信号强度随着发送方和接收方距离的增加而减弱这个也被称为路径损耗（path loss）
当电磁波的一部分受物体和地面反射，在发送方和接收方之间走了不同长度的路径，则会出现多径传播（multipath propagation）

调制技术这里，感觉书上讲的不是很好，可能需要参考一下谢希仁的计网看一下。

隐藏终端问题，你应该知道的

CMDA(Code Division Multiple Access，码分多址)
在CDMA协议中，要发送的每个比特都通过乘以一个信号的比特来进行编码，这个信号的变化速率（通常称为码片速率，chipping rate）比初始数据比特的变化速率快的多。

我们在发送方去看:
我们关注第i个数据比特$$d_i$$。对于$d_i$比特传输时间的第m个微时隙，CDMA编码器的输出$$Z_{i,m}$$是$d_i$乘以分配的CDMA编码的第m比特$c_m$：
$$
Z_{i,m}=d_i·c_{m}
$$
站在接收方的角度去看，从接收方收到的$Z_{i,m}$恢复出初始的数据比特$d_i$
$$
d_i=\frac{1}{M}\sum_{m=1}^{M}Z_{i,m}·c_m
$$

我们需要考虑到出现干扰时的情况：
CDMA对于干扰比特信号是加性的。当存在多个发送方时，发送方s计算它编码后的传输$Z^s_{i，m}$,计算方法与上面的式子完全相同。然而在第i个比特时隙的第m个微时隙期间，接收方现在收到的值是在那个微时隙中从所有N个发送方传输的比特的总和：
$$
Z^*_{i,m}=\sum_{s=1}^{N}Z^s_{i,m}
$$
此时我们采用下面的公式便可以恢复一个给定的发送方发送的数据：
$$
d^t_i=\frac{1}{M}\sum_{m=1}^{M}Z^*_{i,m}·c^t_m
$$

### 7.3 WIFI:802.11 无线LAN

下表是关于IEEE 802.11 标准小结

| 标准     | 频率范围 | 数据率   |
| -------- | -------- | -------- |
| 802.11b  | 2.4GHz   | 11Mbps   |
| 802.11a  | 5GHz     | 54Mbps   |
| 802.11g  | 2.4GHz   | 54Mbps   |
| 802.11n  | 2.5~5GHz | 450Mbps  |
| 802.11ac | 5GHz     | 1300Mbps |

#### 7.3.1 802.11体系结构
802.11体系结构的基本构件模块是基本服务集（Basic Service Set，BSS）。一个BSS包括一个或者多个无线站点和一个在802.11术语中称为接入点（Acess Point，AP）的中央基站（base station）。AP一般连接到一个互联设备，也就是交换机或者路由器上。在典型的家庭网络中，有一个AP和一台将该BSS连接到因特网中的路由器（通常综合成为一个单元）。
（看完上面，你应该终于懂了吧，这就是在实际生活中，我们以为只存在路由器的原因，接入点其实是AP)

配置AP的无线LAN经常被称作基础设施无线LAN（infrastructure wireless LAN）。其中的基础设施是指AP连同互联AP和一台路由器的有线以太网。同时还存在着只有无线站点的自组织网络，该网络是彼此已经发现相互接近且有通信需求的移动设备组成，并且在它们所处环境中没有预先存在的网络基础设施。

信道与关联
**当网络管理员配置一个AP时，管理员为该接入点分配一个单字或者双字的服务集标识符（Service Set Identifier，SSID）**同时管理员还要为AP分配一个信道号。我们把一段频率分为多个信道号。当且仅当两个信道由4个或更多信道隔开时它们才无重叠。

WIFI丛林（WIFI jungle）是一个任意物理位置，在这里无线站点能从两个或者多个AP中收到很强的信号。这些AP中的每一个都可能位于不同的子网中，并被独立分配一个信道。
为了获得因特网接入，你的无线站点需要加入其中一个子网并因此需要和其中的一个AP相关联（associate）。关联意味着这一无线站点在自身和该AP之间创建一个虚拟链路。特别是，你需要知道，仅有关联的AP才向你的无线站点发送数据帧，并且你的无线站点也仅仅通过该关联AP向因特网发送数据帧。

在802.11标准中，要求每个AP周期性地发送信标帧（beacon frame），每个信标帧都具有包括该AP的SSID和MAC地址。你的无线站点为了得知正在向你发送信标帧的AP，扫描信道，找出来自可能位于该区域的AP所发出的信标帧。通过信标帧了解到可用AP后，你选择一个AP用于关联。（熟悉把，这大概就是你打开设备WIFI然后连接网络的过程）

扫描信道和监听信标帧的过程被称为被动扫描（passive scanning）。无线主机也能够执行主动扫描（active scanning）。这是通过向位于无线主机范围内的所有AP广播探测完成的。AP用一个探测响应帧应答探测请求帧。无限主机则能够在响应的AP中选择某AP与之相关联。

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/170f7f5ff3442c5f9e59a8ed448a797a.png" style="zoom:50%;" />

选定与之相关联的AP后，无线主机向AP发送一个关联请求帧，并且该AP'以一个关联响应帧进行响应。注意到对于主动扫描，需要这种第二次请求/响应握手。因为一个对初始探测请求帧进行响应的AP并不知道主机选择那个（或者多个**（应该知道了吧，有些设备可以存在双WIFI）**）响应的AP进行关联。一旦与一个AP关联，该主机希望加入到该AP所属的子网中，因此，该主机通常会通过关联的AP向该子网发送一个DHCP发现报文，以获取在该AP子网中的一个IP地址。一旦获得地址，网络的其他部分将直接视你的主机为该子网中的另一台主机。

有些时候无线站点可能要向该AP鉴别它自身。一种被许多公司采用的方法是，基于一个站点的MAC地址允许其接入一个无线网络。第二个方法是应用用户名和口令。在两种情况下，AP通常与一个鉴别服务器进行通信，使用一个诸如RADIUS或DIAMETER的协议，在无线终端站点和界别服务器之间中继信息。分离鉴别服务器和AP，使得一个鉴别服务器可以服务于多个AP，将鉴别和接入的决定集中到单一服务器中，使AP费用和复杂型较低。

#### 7.3.2 802.11 MAC协议
**许多无线设备或AP自身可能希望同时经过相同信道传输数据帧，因此需要一个多路访问协议来协调运输。**在下面将无线设备或AP都称为站点（station）。
在这里采用了一个随机访问协议，这个协议被称为带碰撞避免的CSMA(CSMA with collision avoidance，CSMA/CA)，CSMA代表载波侦听多路访问，就是在每个站点在传输之前侦听信道，并且一旦侦听到该信道忙则抑制传输。

在这里我们需要结合CSMA/CD去理解，CD中如果检测到另外一个节点传输干扰帧，就停止传输该帧。然后在CA中并不是如此，一旦节点开始发送一个帧，就不会返回。碰撞存在时仍然发送整个帧将会严重降低多路访问协议的性能。

我们先分析一些802.11中的链路层确认（link-layer acknowledgement）

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/ec19da624849433640313a52445f39f4.png" style="zoom:50%;" />

目的节点收到一个一个通过CRC校验的帧后，它等待一个被称作短帧间间隔（Short Inter-Frame Spacing，SIFS）的一小段时间，然后发回一个确认帧。如果发送站点在给定时间内未收到确认帧，它假定出现了错误并重传该帧，使用CSMA/CA协议访问该信道。如果在多次固定重传后仍未收到确认，发送站点将放弃发送并丢弃该帧。

现在描述802.11的CSMA/CA协议
1）如果某站点最初监听到信道空闲，他将在一个被称作分布式帧间间隔（Distributed Inter-Frame Space）的短时间段之后，发送该帧。
2）否则该点将选择一个随机回退值，并在侦听到信道空闲时递减该值，。当侦听到信道忙时，计数值保持不变。
3）当计数值为0时（注意到，此时也要保证信道处于空闲），该站点发送整个数据帧并等待确认。
4）如果收到确认，发送站点知道它的帧已经被目的站点接收了。如果要发送另外一帧，它将从第二步开始CSMA/CA协议。如果未收到确认，发送站点将重新进入第二步中的回退阶段，并从一个更大的范围内选取随机值。

1.处理隐藏终端：RTS和CTS

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/7fdb2958b07fbd2a23a2835a77c41ada.png" style="zoom:50%;" />

在上图所给出的环境下，每个无线站点对于AP都不隐藏，两者彼此却是隐藏的。

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/174b8d363eb2ae1f01015f7b1c3c4e4b.png" style="zoom: 67%;" />

站点可以通过使用一个短请求发送(Request to Send,RTS)控制帧和一个短允许发送（Clear to Send,CTS)控制帧来预约对信道的访问。
当发送方要想AP发送一个DATA帧时，它能够先向AP发送一个RTS帧，指示传输DATA帧和确认帧（ACK）需要的总时间。当AP收到RTS帧后，它广播一个CTS帧作为响应。该CTS帧有两个目的：给发送方明确的发送许可，也指示其他站点在预约期间内不要发送。

RTS/CTS一般用于长数据帧预约信道。在实际中，每个无线节点可以设置一个RTS门限值，仅当帧长超过门限值时，才使用RTS/CTS序列。对许多无线站点而言，默认的RTS门限值大于最大帧长值，因此对于发送的DATA帧，RTS/CTS序列都被跳过。

2.使用802.11作为一个点对点链路
如果两个节点每个都具有一个定向天线，它们可以彼此将其定向天线指向对方，并基本上是在一个点对点的链路上运行802.11协议。

#### 7.3.3 IEEE 802.11 帧
<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/22a61fd0215d20fbff8f65aa1921c877.png" style="zoom: 67%;" />

1.有效载荷与CRC字段
有效载荷通常是一个IP数据报或者ARP分组组成。尽管这一字段允许的最大长度为2312字节，但是它通常小于1500字节，放置一个IP数据报或者ARP分组。

2.地址字段
有4个地址字段。
1）地址2是传输该帧的站点的MAC地址。2）地址1是要接收该真的的无限站点的地址。3）地址3：我们知道BSS是一个子网的一部分，并且这个子网经一些路由器与其他子网相连。地址3包含整个路由器接口的MAC地址。

3.序号、持续期和帧控制字段
使用序号可以使接收方区分新传输的帧与以前帧的重传。
在前面讲述RTS/CTS的时候，我们已经知道，允许传输节点预约信道一段时间，包括传输其数据帧的时间和传输确认的时间。这个持续期被包括在该帧的持续字段中。
控制字段，我们来讨论在控制字段中一些比较重要的子字段。类型和子类型字段用于区分关联、RTS、CTS、ACK和数据帧。To和From字段用于定义不同字段的含义。WEP字段用于指示是否使用了加密。

#### 7.3.4 在相同的IP子网中的移动性
这个还是挺简单的

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/63bb6983ff6c81dwuxianea7c7fe38db0eda73.png" style="zoom:50%;" />

当连接两个BSS的互联设备不是一台路由器，故在两个BSS中的所有站点（包括AP）都属于同一个IP子网。因此无线设备从BSS1移动到BSS2时，它可以保持自己的IP地址和所有正在进行的TCP连接。

这个时候可以通过交换机自身的自学习功能，然后更新一次转发表，从而知道接下来的转发如何进行，完成对无线设备的定位。

#### 7.3.5 802.11中的高级特色
1.802.11速率适应
通过自适应地根据当前和近期信道特点来选择下面的物理层调制技术。
2.功率管理
使得一个节点可以在睡眠和唤醒状态之间交替。

#### 7.3.6 个人域网络：蓝牙和ZigBee
IEEE 802.11 WIFI标准主要针对相距多达100m的设备间的通信。两个其他的IEEE 802无线协议是蓝牙和ZigBee

1.蓝牙
IEEE 802.15.1网络以低功率和低成本在小范围内运行。它本质上是一个低功率、小范围、低功率的“电缆替代”技术，用于计算机与其无线键盘、鼠标或其他外设设备如蜂窝电话、扬声器、头戴式耳机以及其他设备的互联。802.15.1 网络有时候被称为无线个人域网络（Wireless Personal Area Network,WPAN)。802.15.1网络以TDM方式工作于2.4GHz无线电波段，每个时隙长度为625us。在每个时隙内，发送方利用79个信道中的一个进行传输，同时从时隙到时隙以一个已知的伪随机方式变更信道。这种被称作调频拓展频谱（Frequency-Hopping Spread Spectrum，FHSS）的信道跳动的形式将传输及时扩展到整个频谱。

802.15.1网络是自组织网路：不需要网络基础设施来互联设备。802.15.1设备首先组织成一个多达8个活动设备的皮可网（piconet)，这些设备之一被指定为主设备，其余设备充当从设备，。主节点真正控制皮可网，即它的时钟确定了皮可网中的时间。它可以在每个奇数时隙中发送，而从设备仅当主设备在前一时隙与其通信后才可以发送，并且智能发送给主设备。

2.ZigBee
IEEE标准化的第二个个人域网络是802.14.5，他被称为ZigBee。ZigBee较之蓝牙其服务目标是低功率、低数据率、低工作周期的应用。

ZigBee网络中的节点具有两个特色。
$$\enclose{circle}{1}$$:多个所谓“简化功能设备”在单个“全功能设备控制下作为从设备运行的，一个全功能设备能够作为一个主设备运行。多个全功能设备还可以配置为一个网状（mesh）网络，其中全设备在它们之间发送帧。
$$\enclose{circle}{2}$$:ZigBee网络可以共享我们在其他链路层协议中遇到的：RTS/CTS机制，具有二进制回退的载波侦听和随机访问协议，以及时隙的固定、确保的分配。

### 7.4 蜂窝因特网接入
#### 7.4.1 蜂窝网体系结构概述
全球移动通信系统（GSM）
第一代（1G）系统是模拟FDMA系统，专门用于语音通信。
第二代（2G）蜂窝网体系结构：语音与电话网连接
蜂窝（cellular）是指，由一个蜂窝网覆盖的区域被分成许多称作小区（cell）的地理覆盖区域。

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/8a30b064dc2bf91e1bbbfb118a6cc7bc.png" style="zoom: 25%;" />

小区如在图中左侧的六边形所示。每个小区包含一个收发基站（Base Transceiver Station，BTS），负责向位于其小区内的移动站点发送或接收信号。一个小区的覆盖区域取决于众多因素，包括BTS的发射功率、用户设备的传输功率、小区中的障碍建筑物以及基站天线的高度。今天许多系统将BTS放置在3个小区的交叉处，使具有有向天线的单个BTS为三个小区提供服务。

2G蜂窝系统的GSM标准对空中接口使用了组合的FDM/TDM。在组合的FDM/TDM系统中，信道被划分为若干频率子带；对于每个子带，时间又被划分为帧和时隙。因此，对于一个组合的FDM/TDM系统，如果信道被划分为F个子带，并且时间又被划分为T个时隙，那么该信道能够支持F·T个并发的呼叫。

一个GSM网络的基站控制器（Base Station Controller，BSC）通服务于几十个收发基站。BSC的责任是为移动用户分配BTS无线信道，执行传呼（paging），执行用户的切换。基站控制其及其控制的收发基站共同构成了GSM基站系统（Base Station System，BSS）
**在前面的内容中出现了一个基本服务集（Basic Service Set，BSS），注意区分***

在用户鉴别和账户管理以及呼叫建立和切换中，移动交换中心（Mobile Switching Center，MSC）起着决定性的作用。单个MSC通产将包括5个BSC。一个蜂窝提供商的网络有若干MSC，使用称为网关MSC的特殊MSC将提供商的蜂窝网络与更大的公共电话网相连。

#### 7.4.2 3G蜂窝数据网：将因特网拓展到蜂窝用户
<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/919599b042c702ecb6d31da18eb60a7b.png" style="zoom:50%;" />

1.3G核心网

不去触动现有核心GSM蜂窝语音网，增加与现有蜂窝语音网平行的附加蜂窝数据功能。

在3G核心网中有两类节点：服务通用分组无线服务支持节点（Serving Generalized packet radio service Support Node，SGSN）和网关GPRS支持节点（Gateway GPRS  Support Node）
GPRS（General Packet Radio Service）表示通用无线服务。
一个SGSN负责向位于其连接的无线接入网中的移动节点交付数据报。SGSN与该区域蜂窝语音网中的MSC进行交互，提供用户认证和切换，维护活跃移动节点的位置（小区）信息，执行位于无线接入网中的移动节点与GGSN之间的数据报转发。

GGSN起着网关的作用，将多个SCSN连接到更大的因特网。

2.3G无线接入网：无线边缘

3G无线接入网（radio access network）是我们作为3G用户看见的无线第一跳网络。无线电网络控制器（Radio Network Controller，RNC）通常控制几个小区的收发基站。RNC不仅通过SGSN与分组交换的因特网连接，又通过MSC与电路交换蜂窝语音网连接。因此，尽管3G蜂窝语音服务和蜂窝数据服务使用不同的核心网，但它们共享一个相同的第一/最后一跳无线电接入网。

3G UMTS（Universal Mobile Telecommunications System，通用移动通信系统）在TDMA时隙中采用称为直接序列宽带CDMA（Direct Sequence Wideband CDMA，DS-WCDMA）的CDMA技术。

与WCDM规范有关的数据服务被称为高速分组接入（High Speed Packet Access，HSPA）

#### 7.4.3 走向4G；LTE

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/6db8eac6d27f6501f5e575aa0bf77803.png" style="zoom:50%;" />

1.4G系统体系结构：一个全IP核心网

1）一种统一的、全IP网络体系结构。在4G体系结构中数据和语音都承载在IP数据报中，来自/去往无线设备，到分组网关（P-GW），该P-GW将4G边缘网络连接到网络的其他部分。
2）4G数据平面和4G控制平面的清晰分离
3）无线电接入网与全IP核心网之间的清晰分离
4）eNodeB是2G基站和3G无线网络控制器的逻辑后代。它的数据平面作用是在UE和P-GW之间转发数据报。UE数据报在eNodeB被封装，并且通过4G网络的全IP强分组核（EPC）以隧道形式传输到P-GW。
5）分组数据网络网关（Packet Data Network Gateway，P-GW）,给UE分配IP地址，并且保证QoS实施，当向或从UE发送数据报是，它也执行数据报封装/解封装。
6）服务网关（S-GW）是数据平面移动性锚点，即所有的UE流量都将通过S-GW传递。该S-GW也执行收费/记账功能以及法定的流量拦截。
7）移动性管理实体（Mobility Management Entity，MME）代表位于它所控制单元中的UE，执行连接和移动性管理。它从HHS接收订购信息。
8）归属用户服务（Home Subscriber Server，HHS）包含了包括漫游接入能力、服务质量配置文件和鉴别信息的UE信息。

2.LTE无线接入网
LTE在下行信道采用频分复用和时分复用结合的方法，称之为正交频分复用（Orthogonal Frequency Division Multiplexing，OFDM）技术。

另一种4G无线技术是WiMAX（全球微波接入互操作）

### 7.6 移动管理：原理

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/89a9170dfb9cb64647b501c45ad99ffd.png" style="zoom:50%;" />

在使能某些服务时，需要保持IP不变。

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/89de7d76f40f61bf5e76a0ecf287eccc.png" style="zoom:50%;" />

在一个网络环境中，一个移动节点的永久居所称为归属网络（home network），在归属网络中代表移动节点执行下面讨论的移动性管理功能的实体叫归属代理（home agent）。移动节点当前所在网路称为外部网络（foreign network）或被访网络（visited network），在外部网络中帮助移动节点做移动管理的实体称为外部代理（foreign agent）。通信者就是移动节点希望与之通信的实体。

#### 7.5.1 寻址
1）外部网络可以向其他所有的网络发通告，告诉他们该移动节点正在它的网络中，这通常可以通过交换域内与域间路由选择信息来实现，而且只需对现有路由选择基础设施做很好的改变便可，外部网络只需通告它有一条正确的路径可将数据报导向该移动节点的固定地址。即告知其他网络它有一条正确的路径可将数据报导向该移动节点的固定地址。这些邻居将在全网广播该路由选择信息，而且是当作更新路由选择信息和转发表的正常过程的一部分来做。当移动节点离开了一个外部网络后加入另一个外部网络时，新的外部网络会通告一条新的通向该移动节点的特殊路由，旧的外部网络将撤销其与移动节点有关的路由选择信息。

2）将外部代理放置在外部网络的边缘路由器上。外部代理的作用之一就是为移动节点创建一个所谓的转发地址（Care-Of Address，COA），该COA的网络部分与外部网络的网络部分相匹配。因此一个移动节点可与两个地址相关联，及其永久地址（permanent address）与其COA。该COA有时又称为外部地址（foreign address）。外部代理的第二个作用是告诉归属代理，该移动节点在它的（外部代理的）网络中且具有给定的COA。
移动节点将COA通告给了归属代理。

#### 7.5.2 路由选择到移动节点
1.移动节点的间接路由选择

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/631f60a262b20aa36b4ddabca410a144.png" style="zoom:50%;" />

归属代理将通信者的原始完整数据报封装（encapsulate）在一个新的（较大的）数据包中，这个较大的数据报被导向交付到移动节点的COA。“拥有“该COA的外部代理将接收并拆封该数据报，即从较大的封装数据报中去除通信者的原始数据报，然后再向移动节点转发该原始数据报。

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/91aeff28f6f15f42ab1ff035cae230e9.png" style="zoom:50%;" />

关于间接路由选择，存在：
1）移动节点到外部代理的协议。
2）外部代理到归属代理的注册协议。外部代理将向归属代理注册移动节点的COA。当某移动节点离开其网络时，外部网络不需要显式地注销COA，因为当移动节点移动到一个新的网络时，随即而来就要注册一个新的COA，这样就完成了注销。
3）归属代理数据报封装协议。
4）外部代理拆封协议。

2.移动节点的直接路由选择

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/c428998cb3110192eefdea15240107d8.png" style="zoom:50%;" />

通信者所在网络中的一个通信者代理（correspondent agent）先知道该移动节点的COA。这可以通过让通信者代理向归属代理询问得知。然后通信者代理可以直接通过隧道技术发往移动节点的COA。通信者本身也可能执行通信者代理的功能。

1）需要一个移动用户定位协议（mobile-user location protocol），以便通信者代理向归书代理查询获得移动节点的COA
2）当节点又在移动的时候，从一个外部网络抵达一个新的外部网络的时候，$\enclose{circle}{1}$创建一个新的协议来告知通信者变化的COA  $\enclose{circle}{2}$ **进行锚处理，将首次发现移动节点的外部网络中的外部代理中的标识标识为锚外部处理（anchor foreign agent）**，当移动节点抵达一个新外部网络后，移动节点向新的外部代理注册，并且新外部代理向锚外部代理提供移动节点新的COA，当锚外部代理收到一个发往以及离开的移动节点的封装数据报后，它可以使用新的COA重新封装数据报并将其转发给该移动节点。如果移动节点其后又移到另一个外部网络中，在该被访网络中的外部代理随后将于锚外部代理联系，以便建立到该新外部网络的转发。

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/1729076988426.png" style="zoom:50%;" />

### 7.6 移动IP

移动IP标准由三部分组成：

1)代理发现
通过一个新的网络地址，才使移动节点中的网络层知道它已经进入一个新的外部网络。这就是代理发现（agent discovery）
代理发现可以通过两种方法实现：经代理通告或经代理请求
代理通告（agent advertisement），外部代理或者归属代理使用一种现有路由器发现协议来通告其服务。该代理周期性地在所有连接的链路上广播一个类型字段为9的（路由器发现）的ICMP报文。路由器发现报文也包含路由器（即该代理）的IP地址，因此允许一个移动节点知道该代理的IP地址。路由器发送报文中还包括了一个移动代理通告扩展，其中包含了该节点所需的附加信息，在这种拓展中由如下一些重要的字段：
$\enclose{circle}{1}$：归属代理比特（H）。指出该代理是它所在网络的一个归属代理
$\enclose{circle}{2}$：外部处理比特（F）。 指出该代理是它所在网络的一个外部代理
$\enclose{circle}{3}$：注册要求比特（R）。 指出在该网络中的某个移动用户必须向某个外部代理注册。特别是，一个移动用户不能在外部网络中获得一个转交地址（COA，Care-Of Address），并且假定由它自己承担外部代理的功能，无须向外部代理注册。
$\enclose{circle}{4}$：M、G封装比特。指出除了”IP中的IP“封装形式外，是否还需要使用其他的封装形式
$\enclose{circle}{5}$：转交地址（COA，Care-Of Address）字段。由外部代理提供的一个或多个转交地址的列表。

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/1729077028166.png" style="zoom:50%;" />

使用代理请求（agent solicitation），一个想知道代理的移动节点不必等待接收代理通告，就能广播一个代理请求报文，该报文只是一个类型值为10的ICMP报文。收到该请求的代理将直接向该移动节点单播一个代理通告，于是该移动节点将继续处理，就好像刚好收到一个未经请求的通告一样。

2)向归属代理注册
一旦某个移动IP节点收到一个COA，则该地址必须要向归属地注册。这个可以通过i外部代理（由它向归属代理注册该COA）或直接通过移动IP节点自己来完成。

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/af74581608239a59332d411e70548e07.png" style="zoom:50%;" />

看这个图基本就可以知道流程了

注意到一般归属代理指定的寿命比移动节点请求的寿命要小

3)数据报的间接路由选择

### 7.7 管理蜂窝网中的移动性
与移动IP相似，GSM选择了一种间接路由选择方法，首先将通信者的呼叫路由选择到移动节点的归属网络，再从哪里到达被访网络。在GSM中，将移动用户的归属网络称作该移动用户的归属公共地域移动网络（home Pubilc Land Mobile Network，home PLMN），我们可以直接将GSM归属PLMN称为归属网络，将被访问的PLMN称为被访网络，是移动用户当前所在的网络。（无语，那为什么不直接那样称呼，就好了）

归属网络中维护着一个称作归属位置注册器（Home Location Register，HLR）的数据库，其中包括它每个用户的永久蜂窝电话号码以及个人概要信息。并且HLR中也包括这些用户当前的位置信息。当一个呼叫定位到一个移动用户时后，通信者与归属网络中的一个称为网关移动服务交换中心（Gateway Mobile services Switching Center，GMSC）的特殊交换机联系。之后GMSC使用归属MSC来代替。

被访问网络维护着一个称作被访问者位置注册（Vistor Location Register，VLR）的数据库。VLR为每个当前在其服务网络中的移动用户包含一个表项，VLR表项因此随着移动用户进入和离开网络而出现或消失。VLR通常与移动交换中心（MSC）在一起，该中心协调到达或离开被访网络的呼叫建立。

#### 7.7.1 对移动用户呼叫的路由选择

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/8a58a3d7f861b78fc1a4b739654e145a.png" style="zoom:50%;" />

这里感觉和移动IP哪里挺相似的。
1）呼叫从通信者通过公共交换电话网到达移动用户归属网络中的归属MSC。
2）归属MSC收到该请求，并且查询HLR来确定用户所在的位置，HLR返回一个移动站点漫游号码（Mobile Station Roaming Number，MSRN），也就是漫游号码（roaming number）。这个和前面的COA相似。如果HLR不具有漫游号码。那么它将返回被访网路中VLR的地址。
3）给的那个一个漫游号码，归属MSC通过网络到达被访网络的MSC建立呼叫的第二步。

到这里呼叫也就完成了，也就是从通信者到达归属MSC，再从归属MSC到达被访MSC，然后再到为用户提供服务的基站。

下面讨论一个地方，HLR是如何得知移动用户位置的信息？
当一个移动用户切换或进入到一个由新的VLR覆盖的被访网络后，移动用户必须向被访问网络注册，这是通过在移动用户和VLR之间交换信令报文来实现的。这一报文告知HLR可以用来联系移动用户的漫游号码，或者VLR地址（它可以用来随后查询以获取移动号码）。作为这个交换的一部分，VLR同样从HLR哪里获取移动用户的信息，以及确定被访网络应该给予移动用户什么样的服务（如果有的话）。

#### 7.7.7 GSM中的切换

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/6fab8494c0dbea51d17886577d83cb5a.png" style="zoom:50%;" />

上图

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/fb02769fca7c1de0948ce6d934011711.png" style="zoom:67%;" />

采用锚MSC的方法，这里和移动管理：原理哪里类似，可以参考

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/6ac0041955f2a7ad453055fb9d18e13c.png" style="zoom:67%;" />

另一种方法则不用维持从锚MSC到当前MSC的单一MSC跳，将直接链接移动用户访问的MSC。每当移动用户移动一个新的MSC后，就让旧MSC将正在进行的呼叫转发给新MSC。

对移动IP和GSM移动性进行比较

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/4322f47066ad8a7c517f644d0d48995e.png" style="zoom:67%;" />

### 7.8 无线和移动性：对高层协议的影响
无线网络在链路层和网络层与有线网络的对应物有重大的区别，在·运输层和应用层的差别较小。


## 第8章 计算机网络中的安全
### 8.1 什么是网络安全
安全通信（secure communication）应该具有的特性：
1）机密性（confidentiality） 2）报文完整性（message integrity） 3）端点鉴别（end-point authentication） 4）运行安全性（operational security）

入侵者可以进行下列行为：
窃听——监听并记录信道上传输的控制报文和数据报文
修改、插入或删除报文或报文内容
或者是假冒另一个实体

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/2c40086d43ff2f45c5db07e508a78fe5.png" style="zoom:50%;" />

在发送方，对明文（plaintext，cleartext）使用加密算法（encryption algorithm）形成密文（cipher text）。然后在接收方，使用解密算法（decryption algorithm）对密文进行解密可以得到明文。

m明文，$K_A$密钥，$K_B$密钥，$K_A(m)$密文, $K_B(K_A（m))$=m

在对称密钥系统（symmetric key system）中，双方的密钥是相同的并且是秘密的。在公开密钥系统中（public key system）中，使用一对密钥：一个密钥为众所周知（这里是指所有人，全世界上的人），另一个密钥只有一方知道。

### 8.2.1 对称密码体制

可以根据攻击者所拥有的信息将攻击分为三种：
1）唯密文攻击：知道密文
2）已知明文攻击：知道部分的明文和密文对
3）选择明文攻击：知道明文就知道密文

单码代替密码（monoalphabetic cipher）

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/c4e57abcba0a820acd7a5568c197eac2.png" style="zoom:50%;" />

多码代替密码（polyalphabetic encryption)

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/3ec8ff3095d54330e14bbb00a76d54fe.png" style="zoom:50%;" />

1.块密码
块密码（block cipher）
较为基础的是使用映射表去标识输入和输出
但是这种做法当分块的比特过大时，计算机将需要大量的内存去维持这张表，因此从往往采取函数模拟随机排列表。

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/f745a0e9a67b0abf669ed28f2d4a3c38.png" style="zoom:50%;" />

这里比较有意思的是这句话：在经历了n次循环之后，该函数可以提供一个64比特的密文块，这种循环的目的是使得每个输入比特影响最后输出比特的大部分。（即使不是全部）**（如果仅使用一次循环，一个给定输入比特将仅影响64输出比特中的8比特）**这种块密码算法的密钥将是8张排列表。（假定置乱函数是公共已知的）

DES（Data Encryption Standard，数据加密标准），3DES，AES（Advanced Encryption Standard，高级加密标准）。这些标准都是使用了函数，同时也都使用了比特串作为密钥。例如。**DES使用了具有56比特密钥的64比特快，AES使用128比特块，能够使用128、192、256比特长的密钥进行操作。**

2.密码块链接
这个地方感觉书上有很大问题，可以看书再去思考一下

#### 8.2.2 公开密钥加密

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/e73aad0e58cc1b33d4639aa454fb1dd9.png" style="zoom:50%;" />

在这里公钥$K_B^+$众所周知，而私钥$K_B^-$只有接收方知道.
这样存在缺点，由于公钥公开和加密算法已知，所有人都知道公钥和加密算法，因此接收方无法鉴别确认发送者是谁

（刚才又差点晕了，我们需要留意加密算法和密钥是两种东西，密钥是一串数字或字符，而加密算法是对明文处理的方法，比如异或，与这些之类的，然后得到密文）
1.RSA
我觉得这里可以直接上图片

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/be9ca9083b167ec477c30176cd74d778.png" style="zoom: 67%;" />

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/a7736406f91688e1e3b44c6b5f2c2a15.png" style="zoom:67%;" />

e用于加密，d用于解密。

公钥$K_B^+${n,e},私钥$K_B^+${n,d}

2会话密钥
(这个地方我也晕了，我记得，不对，是我刚开始晕了，后续我明白了)
RSA会使用太多的时间，因此经常将其与对称密钥密码结合起来使用，发送方选择一个用于加密数据本身的密钥，这个密钥将其称为会话密钥（session key），该会话密钥表示为$K_S$。发送方必须将这个会话密钥告知接收方，因为这是它们在对称密钥密码中所使用的共享对称密钥。发送方可以使用接收方的RSA公钥来加密该会话密钥。接收方在收到该RSA加密的会话密钥后，可以通过使用RSA的私钥进行解密然后得到会话密钥$K_S$。这是相当于是使用公开密钥系统对对称密钥系统要使用的密钥进行了安全传递。

### 8.3 报文完整性和数字签名
报文完整性（message integrity）也被称为报文鉴别。除了报文完整性之外，我们还需要讨论另外两个主题：数字签名和端点鉴别。

发送方在收到报文的时候，希望可以证实两件事情：
1）该报文的确来自发送方
2）该报文在到接收方的途中没有被篡改

#### 8.3.1 密码散列函数

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/5b7845637976550bf5eaf329219a4214.png" style="zoom: 67%;" />

散列函数以m作为输入，并计算得到一个称为散列的固定长度的字符串H（m）。

密码散列函数（cryptographic hash function）要求具有下列附加的性质：
找到任意凉饿不同的报文x和y使得H(x)=H(y)，在计算上是不可能的。

MD5散列算法
1）填充——先填1，然后填足够多的0，直到报文长度满足一定的条件；
2）添加——在填充前添加一个用64比特表示的报文长度；
3）初始化累加器；
4）循环——在最后的循环步骤中，对报文的16字块进行4轮处理。
最后生成一个128比特的散列
（我现在和我当初看书时写的批注一样，感觉纯在放屁，无聊的东西，说了又和没说一样，这本书感觉还是有不足的地方在的）

SHA-1（Security Hash Algorithm）生成一个160比特的报文摘要。较长的输出长度可以使SHA-1更安全。
#### 8.3.2 报文鉴别码
<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/00f5b4fb15a091cc9ab67386e6c9d9ca.png" style="zoom: 67%;" />

发送方和接受夫昂共享一个秘密s。这个共享的秘密是一个比特串。他被称为鉴别密钥（authentication key）。使用这个共享秘密，报文完整性可以执行如下：
1）发送方生成报文m，用s级联（**级联（cascade）在计算机科学里指多个对象之间的映射关系，建立数据之间的级联关系提高管理效率**）m可以生成m+s，并且计算H（m+s）。H（m+s）被称为报文鉴别码（Message Authentication Code，MAC）
2）然后发送方将MAC附加到报文m上，生成拓展报文（m，H（m+s）），并将该拓展报文发送给接收方。
3）接收方接收到一个拓展报文（m，h），之后，可以根据已知的s和拓展报文中的m求得H（m+s)，然后与h进行对比，便可以做出判断。

注意：这里的MAC并不是我们前面所学的媒体访问控制Medium Access Control而是报文鉴别码Message Authentication Code

我们可能会思考如何分发这个共享秘密呢？
在链路状态路由算法中，在某种程度上，需要向自治系统中的每台路由器分发该秘密鉴别密钥。一名网络管理员可以通过物理访问每台路由器来实际完成这项工作。或者，如果这名网络管理员不够勤快，并且每台路由器都有它自己的公钥，那么该网络管理员可以用路由器的公钥加密鉴别密钥并分发给任何一台路由器，从而通过网络向路由器发送加密的密钥。

#### 8.3.3 数字签名
数字签名（digital signature）
负责人使用i自己的私钥签署文档。别人可以使用对应的私钥进行鉴别。

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/46892316971cb3f309df1ab5b00ba1ba.png" style="zoom:67%;" />

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/c454bc873facd72c22b5db89fc6c0307.png" style="zoom:67%;" />

公钥认证
公钥认证（public key certification）,即证明一个公钥属于某个特定的实体。

将公钥和特定实体绑定通常使由认证中心（Certification Authority，CA）完成的，CA的职责就是使识别和发行证书合法化。CA具有以下作用：
1）CA证实一个实体的真实身份。
2）一旦CA验证了某个实体的身份，这个CA会生成一个将其身份和实体的公钥绑定起来的证书。（certificate）

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/bc52fddb6f68a34033faaeaa59715e43.png" style="zoom: 50%;" />

可以使用CA的公钥从证书中拿到Bob的公钥

<img src="D:/HuaweiMoveData/Users/zzj123/Desktop/%E8%80%83%E7%A0%94/408/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/4ab08789086b3ff3921cd643b7503c34.png" style="zoom:67%;" />

(上图感觉是没用的，但是还是放一下吧)

###  8.4 端点鉴别
端点鉴别（end-point authentication）就是一个实体经过计算机网络向另一个实体证明其身份的过程。

鉴别应当在报文和数据交换的基础上，作为某鉴别协议（authentication protocol）的一部分独立完成。鉴别协议通常在两个通信实体运行其他协议之前运行。鉴别协议首先先建立起相互满意的各方的标识；仅当鉴别完成之后，各方才继续下面的工作。

#### 8.4.1 鉴别协议 ap1.0
发送方直接向接收方表明身份
这样容易被冒充

<img src="../../../../picture/d10ab686f398383023b4a83e4aee8a8b.png" style="zoom:50%;" />

#### 8.4.2 鉴别协议 ap2.0
发送方总是有一个用于通信的周知网络地址（如一个IP地址），接收方可以通过验证携带鉴别报文的IP数据报的源地址与接收方的周知IP地址相匹配来进行鉴别。

但是有这样的一种情况，如果一个人可以访问操作系统代码并且可以构建自己的操作系统内核：生成一个数据报，并在IP数据报中填入我们希望的任意源地址，再通过链路层协议把生成的数据报发送到第一跳路由器，此后，具有不正确源地址的数据报就会忠实地向接收方转发。

其实采用只接受发送方自身源地址数据报的第一跳路由器就可以避免掉这种IP哄骗。

<img src="../../../../picture/2f3a14aeb11f9b83431faae0320c9cdd.png" style="zoom:50%;" />

#### 8.4.3 鉴别协议 3.0
使用秘密口令。口令是鉴别者与被鉴别者之间的一个共享秘密。

<img src="../../../../picture/2692891910f116532081faf2066e8c8e.png" style="zoom:67%;" />

#### 8.4.4 鉴别协议 3.1
可能我们可以想到的是对口令进行加密

回访攻击（payback attack）
但是这样会出现只要攻击方窃取到发送方的加密之后的口令，并以此进行回放，就可以假冒发送方

#### 8.4.5 鉴别协议 4.0
不重数（nonce）是指在一个协议的生存期中只使用一次的数。

这里大概就是我们在实际生活中用到很多的验证码

<img src="../../../../picture/173883a2f6f7d48b25082cb8b01c2a87.png" style="zoom:50%;" />

<img src="../../../../picture/56463966a81a7205316049730854f189.png" style="zoom:50%;" />

#### 8.5 安全电子邮件
我们可能会考虑到以个问题，**“为什么要在因特网的多个层次上提供安全性功能呢？”**这样类似的问题，我们在前面也已经想过，之前的那个问题是，为什么我们需要在运输层、网络层、以及链路层都需要采用校验和，这样难道不多余吗？那里的回答是不，在这里的回答也是不。

#### 8.5.1 安全电子邮件
要求具有：1）机密性   2）发送方鉴别  3）报文完整性

<img src="../../../../picture/58e1d1458145618e5777cc0916f64908.png" style="zoom:50%;" />

看懂这个，你也经懂了，加油！

#### 8.5.2 PGP
PGP（Pretty Good Privacy）是电子邮件加密方案的一种

PGP软件的不同版本使用MD5或者使用SHA来计算报文摘要；使用CAST、三重DES或IDEA及逆行对称密钥加密；使用RSA进行公开密钥加密。

安装PGP时，软件为用户产生一个公开密钥对。该公钥被张贴到用户的网站上或者是被放置在某台公钥服务器上。私钥则使用用户口令进行保护。用户每次访问私钥时都要输入这个口令。PGP提供数字签名和加密功能。

PGP也提供一种公钥认证机制。PGP公钥可以由一个可信Web验证。当A相信一个密钥/用户名对确实匹配时，它自己就可以验证这一密钥/用户对。此外，PGP允许A为它信任的用户鉴别提供更多密钥提供担保。一些PGP用户通过保持密钥签署方（key-signing party）互相签署对方的密钥，用户实际走到一起，交换公钥，并用自己的私钥对对方的公钥签名来互相验证密钥。（这个像不像微信的好友帮你找回密码）

### 8.6 使TCP连接安全：SSL
安全套接字层（Security Socket Layer，SSL），SSL版本3的一个稍加修改的版本称为运输层安全性（Transport Layer Security，TLS）

在这里需要注意的是，机密性、数据完整性、服务器鉴别和客户鉴别。

<img src="../../../../picture/f98800953113905ad643e9447d31f6ba.png" style="zoom:67%;" />

#### 8.6.1 宏观描述
我们先描述一个简化版本的SSL，称之为类SSL。
（SSL这个东西有点复杂，我晕了，现在）

我们的案例是，针对一个客户（Bob）和一个服务器（Alice）之间进行的，其中Alice既有私钥/公钥对和将她的身份与其公钥绑定的证书。

1.握手

<img src="../../../../picture/ccf22eeb0b5fd7ec7426622c9f8a560f.png" style="zoom:50%;" />

首先建立起一个TCP连接，然后Bob向Alice发送一个hello报文，Alide使用自己的证书进行回应，证书种包含了她的公钥，Bob可以得到Alice的公钥，然后，Bob生成一个主密钥MS（该MS将只用于这个SSL会话），用Alice的公钥加密该MS以生成加密的主密钥（EMS），并将该EMS发送给Alice，Alice使用自己的私钥进行解密可以得到MS。Bob和Alice都知道了用于这次SLL会话的主密钥。

2.密钥导出

Alice1和Bob都使用MS生成四个密钥：
$E_B$，用于从Bob发送到Alice的数据的会话加密密钥
$M_B$，用于从Bob发送到的Alice的数据的会话MAC密钥
$E_A$，用于从Alice发送到Bob的数据的会话加密密钥
$M_B$，用于从Alice发送到Bob的数据的会话MAC密钥

其中的两个加密密钥将用于加密数据；两个MAC密钥将用于验证数据的完整性。

3.数据传输

SSL将数据流分割为记录，对每个记录附加一个完整性检查，然后加密该“记录+MAC”。为了产生这个MAC，Bob将数据连同密钥$M_B$放入一个散列函数中，为了加密“记录+MAC”这个包，Bob将使用它的会话密钥$E_B$。然后这个加密的包将传递给TCP经因特网传输。

使用序号，对每个SSL记录都加1，Bob不实际在记录中包括一个序号，但当他计算MAC时，他把该序包括在MAC的计算中。所以该MAC现在是数据加MAC密钥$M_B$加当前序号的散列。Alice追踪Bob的序号，通过在MAC的计算中包括适当的序号，使他验证一条记录的数据完整性。

4 SSL记录

<img src="../../../../picture/1f754accf7681e289e1036d815f05b37.png" style="zoom:50%;" />

#### 8.6.2  更完整的描述

1.SSL实验

<img src="../../../../picture/ff09b79896d8f02a1ce2ecc7a5664b22.png" style="zoom:50%;" />

步骤5中客服发送一个级联它已发送和接收的所有握手报文的MAC。服务器能够比较这个MAC与它已经接收和发送的握手报文的MAC。如果有不一致，服务器能够终止该连接。步骤6中，服务器发送一个它已经看到的握手报文的MAC，允许客户检查不一致性。

在SSL中，不重数用于防御“连接重放”，而序号用于防御在一个进行中的会话中重放个别分组。

2.连接关闭

在类型字段中，指出该记录是否用于终止该SSL会话的。

#### 8.7 网络安全性：IPsec和虚拟专用网

IP安全协议协议（IP security protocol）通常被称为IPsec。使用IPsec可以创建在公共因特网之上的虚拟专用网（Virtual Private Network，VPN）

提供的服务要具有：机密性、源鉴别、数据完整性和重放攻击防护。

#### 8.7.1 IPsec和虚拟专用网

<img src="../../../../picture/43ff3b0f9f9a5d1670c0ef4919e995ce.png" style="zoom:50%;" />

当两台主机需要跨越公共因特的路径时，这些流量在进入因特网之前进行加密。

需要将IPv4数据报转化为IPsec数据报，然后将该IPsec数据报转发到因特网中。该IPsec实际上具有传统的IPv4首部。IPsec数据报的载荷是被加密的。

#### 8.7.2 AH协议和ESP协议
在IP协议族中，有两个主要协议：鉴别首部（Authentication Header，AH）协议和封装安全性载荷（Encapsulation Security Payload，ESP）协议。AH协议提供源鉴别和数据完整性服务，但不提供机密性服务。ESP协议提供了源鉴别、数据完整性和机密性服务。

#### 8.7.3 安全关联
在从源实体向目的实体发送IPsec数据报之前，源和目的实体之间创建一个网络层的逻辑连接，该逻辑连接称为安全关联（Security Association，SA）。一个SA是单工逻辑连接；也就是说，他是从源到目的地单向的。如果两个实体需要彼此之间发送安全数据报，那么就是需要建立两个SA，每个方向一个。

<img src="../../../../picture/ee9075a681e7ed296c55943c92beb155.png" style="zoom:67%;" />

一个IPsec实体经常维护许多SA的状态信息。一个IPsec实体在它的安全关联数据库（Security Association Database，SAD）中存储其所有SA的状态信息，SAD是实体操作系统内核中的一个数据结构。

#### 8.7.4 IPsec数据报
IPsec有两种不同的分组模式：
1）隧道模式（tunnel mode）
2）运输模式（transport mode）

<img src="../../../../picture/fd7f7dc76dc4313e8d11872d4a8b848a.png" style="zoom: 67%;" />

在新的IPv4首部中，协议号设置为50，指示这是一个使用ESP协议的IPsec数据报。（这里是不是和IPv4、IPv6哪里很像）

我们来看一下ESP尾部：
ESP首部由三个字段组成：填充、填充长度和下一个首部。使用填充（由无意义的字节组成），使得当其实际加上初始数据报（连同填充长度和下一个首部字段）形成的“报文”是块的整数倍。填充长度字段指示接收实体插入的填充式多少。下一个首部字段指示包含在载荷数据字段中数据的类型。载荷数据和ESP尾部级联起来并被加密。

ESP首部：该首部以明文发送，它由两个字段组成：SPI字段和序号字段。SPI字段指示接收实体该数据报属于那个SA；接收实体能够用该SPI索引以确定适当的鉴别/解密算法和密钥/序号字段用于防御重放攻击。

ESP MAC是根据除了新IPv4首部之外的计算得出的。

看一下接收方对报文的处理：

<img src="../../../../picture/86ac1bdd464b8cfd23330ce121316b15.png" style="zoom:67%;" />

IPsec还维护一个安全策略库（Security Policy Database，SPD），该SPD指示那些类型的数据报（作为源地址、目的IP地址和协议类型的函数）将被IPsec处理；并且对这些将被IPsec处理的数据报应当使用那个SA。

#### 8.7.5 IKE：IPsec中的密钥管理
IPsec可以使用因特网密钥交换（Internet key Exchange，IKE）自动生成SA。

每个IPsec实体具有一个证书，该证书包括了该实体的公开密钥。IKE让两个实体交换证书，协议鉴别和加密算法，并安全地交换用于在IPsec SA中生成会话密钥的密钥材料。

IKE有两个阶段：
1）在报文的第一次交换期间，两侧使用Diffie-Hellman在路由器间生成一个IKE SA。该IKE SA在这两台路由器之间提供了一个鉴别的和加密的通道。在首个报文对交换期间，创建用于IKE SA的加密和鉴别的密钥。还创建了将用于计算后期在阶段2使用的IPsec SA密钥的一个主密钥。
2）在报文的第二次交换期间，两侧通过对其报文签名而透漏了他们的身份。然而这些身份并未透漏给被动的嗅探者，因为这些报文是经过安全的IKE SA 信道发送的。在这个阶段时期，两侧协商由IPsec SA应用的IPsec加密和鉴别算法。

在IKE的第二个阶段，两侧生成在每个方向的一个SA。在阶段2结束的时候，对这两个SA的每一层都建立了加密和鉴别会话密钥。然后这两侧都可以使用SA来发送安全的数据报。在IKE中有两个阶段的基本动机时计算成本，即因为第二阶段并不涉及任何公钥密码，IKE能够以相对低的计算成本在两个IPsec实体之间生成大量的SA。

### 8.8  使无线LAN安全

有线等效保密（Wired Equivalent Privacy，WEP）

#### 8.8.1 有线等效保密
WEP为在主机和无线接入点（即基站）之间提供鉴别和加密的服务。

（我没看懂）

#### 8.8.2 IEEE 802.11 i
（看书吧）

### 8.9 运行安全性：防火墙和入侵检测系统
#### 8.9.1 防火墙
防火墙（firewall）使一个硬件和软件的结合体，他将一个机构的内部网络与整个因特网络隔离开，允许一些数据分组通过而阻止另一些分组通过。防火墙允许网络管理员控制为外部和被管理网络资源之间的访问，这种控制是通过管理流入和流出这些资源的流量实现的。

防火墙的三个目标：
1）从外部到内部和从内部到外部的所有流量都通过防火墙。
2）仅被授权的流量（由本地安全策略定义）允许通过。
3）防火墙免于自身渗透。

防火墙可以分为三类：传统分组过滤器（traditional packet filter）、状态过滤器（stateful filter）和应用程序网关（application gateway）

1.传统分组过滤器
分组过滤器独立地检查每个数据报，然后基于管理员特定的规则决定该数据报应当允许通过还是应当丢弃。

过滤通常基于下列因素：
1）IP源或目的地址
2)在IP数据报中的协议类型字段：TCP、UDP、ICMP、OSPF
3)TCP或UDP的源和目的端口
4）TCP标志比特
5）ICMP报文类型
6）数据报离开和进入网络的不同规则
7）对不同路由器接口的不同规则

一条过滤策略可以基于地址和端口号的结合

2.状态分组过滤器
对了一个连接表

3.应用程序网关
一个应用程序网关（application gateway）是一个应用程序特定的服务器，所有应用程序数据都必须通过它，多个应用程序网关可以在同一个主机上运行，但是每一个网关都有自己的进程的单独服务器。

内部网络通常有多个应用程序网关。

应用程序网关的缺陷：
1）每一个应用程序都需要一个不同的应用程序网关。
2）所有数据都由网关转发，付出的性能负担较重。
3）当用户发起一个请求时，客户软件必须知道如何联系整个网关，并且必须告诉应用程序网关如何连接到那个外部服务器。

#### 8.9.2 入侵检测系统
深度入侵检测（deep packet inspection），查看首部字段以外部分，深入查看分组携带的实际应用数据。

当观察到潜在恶意流量时，能产生告警的设备称为入侵检测系统（Intrusion Detection System，IDS）。滤除可疑流量的设备称为入侵防止系统（Intrusion Prevention System，IPS）
将IDS系统和IPS系统统称为IDS系统。


IDS可以检测多种攻击，包括网络映射（例如使用nmap进行分析）、端口扫描、TCP栈扫描、DoS带宽泛攻击、蠕虫和病毒、操作系统脆弱性攻击和应用程序脆弱性攻击，

<img src="../../../../picture/ec2683d184df89b99bc49303b189eb87.png" style="zoom:67%;" />

为什么需要多个IDS传感器呢？
IDS不仅需要做深度分组检查，而且必须要将每个过往的分组与数以万计的“特征”作比较；这可能会导致极大的处理量，特别是如果机构从因特网内接收每秒数十亿比特的流量更是如此。将IDS传感器进一步向下游放置，每个传感器仅看到该结构流量的一小部分，维护起来更加容易。


IDS系统大致可分为基于特征的系统（signature-based system）或基于异常的系统（anomaly-based system）。基于特征的IDS维护了一个范围广泛的攻击特征数据库。每个攻击特征数据库是与一个活动相关联的规则集。一个特征可能只是有关单个分组的特征列表，或者可能与一系列分组有关。

基于特征的IDS嗅探每个通过它的分组，将每个嗅探的分组与数据库中的特征进行比较。如果某分组（或分组序列）与数据库中的一个特征相匹配，IDS将会产生一个告警。

基于异常的IDS观察正常运行的流量时，他会生成一个流量概况文件。然后，它寻找统计上不寻常的分组流。该怎么区分异常流量和正常流量是一个问题。

